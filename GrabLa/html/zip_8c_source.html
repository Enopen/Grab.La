<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Grabla: minizip/zip.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.0 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>minizip/zip.c</h1>  </div>
</div>
<div class="contents">
<a href="zip_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* zip.c -- IO on .zip files using zlib</span>
<a name="l00002"></a>00002 <span class="comment">   Version 1.01e, February 12th, 2005</span>
<a name="l00003"></a>00003 <span class="comment"></span>
<a name="l00004"></a>00004 <span class="comment">   27 Dec 2004 Rolf Kalbermatter</span>
<a name="l00005"></a>00005 <span class="comment">   Modification to zipOpen2 to support globalComment retrieval.</span>
<a name="l00006"></a>00006 <span class="comment"></span>
<a name="l00007"></a>00007 <span class="comment">   Copyright (C) 1998-2005 Gilles Vollant</span>
<a name="l00008"></a>00008 <span class="comment"></span>
<a name="l00009"></a>00009 <span class="comment">   Read zip.h for more info</span>
<a name="l00010"></a>00010 <span class="comment">*/</span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;zlib.h&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="zip_8h.html">zip.h</a>&quot;</span>
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="preprocessor">#ifdef STDC</span>
<a name="l00021"></a>00021 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;stddef.h&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#  include &lt;string.h&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#  include &lt;stdlib.h&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#endif</span>
<a name="l00025"></a>00025 <span class="preprocessor"></span><span class="preprocessor">#ifdef NO_ERRNO_H</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span>    <span class="keyword">extern</span> <span class="keywordtype">int</span> errno;
<a name="l00027"></a>00027 <span class="preprocessor">#else</span>
<a name="l00028"></a>00028 <span class="preprocessor"></span><span class="preprocessor">#   include &lt;errno.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#endif</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="preprocessor">#ifndef local</span>
<a name="l00033"></a><a class="code" href="zip_8c.html#a08023ea6765c99d60a6a3840cd07156e">00033</a> <span class="preprocessor"></span><span class="preprocessor">#  define local static</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span><span class="comment">/* compile with -Dlocal if your debugger can&#39;t find static symbols */</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#ifndef VERSIONMADEBY</span>
<a name="l00038"></a><a class="code" href="zip_8c.html#a0887c08f255f7a753b460e30ed14a3cf">00038</a> <span class="preprocessor"></span><span class="preprocessor"># define VERSIONMADEBY   (0x0) </span><span class="comment">/* platform depedent */</span>
<a name="l00039"></a>00039 <span class="preprocessor">#endif</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span>
<a name="l00041"></a>00041 <span class="preprocessor">#ifndef Z_BUFSIZE</span>
<a name="l00042"></a><a class="code" href="zip_8c.html#a1491823e6cf52e751120f367bdc68a00">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define Z_BUFSIZE (16384)</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span>
<a name="l00045"></a>00045 <span class="preprocessor">#ifndef Z_MAXFILENAMEINZIP</span>
<a name="l00046"></a><a class="code" href="zip_8c.html#a135c063faff93cb20013a8c28b8d1984">00046</a> <span class="preprocessor"></span><span class="preprocessor">#define Z_MAXFILENAMEINZIP (256)</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span>
<a name="l00049"></a>00049 <span class="preprocessor">#ifndef ALLOC</span>
<a name="l00050"></a><a class="code" href="zip_8c.html#ac5c822e3692a95451e8f70a5916f05a3">00050</a> <span class="preprocessor"></span><span class="preprocessor"># define ALLOC(size) (malloc(size))</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span><span class="preprocessor">#ifndef TRYFREE</span>
<a name="l00053"></a><a class="code" href="zip_8c.html#a5fb23c00a00f3856832e660edc2ab03d">00053</a> <span class="preprocessor"></span><span class="preprocessor"># define TRYFREE(p) {if (p) free(p);}</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span>
<a name="l00056"></a>00056 <span class="comment">/*</span>
<a name="l00057"></a>00057 <span class="comment">#define SIZECENTRALDIRITEM (0x2e)</span>
<a name="l00058"></a>00058 <span class="comment">#define SIZEZIPLOCALHEADER (0x1e)</span>
<a name="l00059"></a>00059 <span class="comment">*/</span>
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="comment">/* I&#39;ve found an old Unix (a SunOS 4.1.3_U1) without all SEEK_* defined.... */</span>
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 <span class="preprocessor">#ifndef SEEK_CUR</span>
<a name="l00064"></a>00064 <span class="preprocessor"></span><span class="preprocessor">#define SEEK_CUR    1</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span>
<a name="l00067"></a>00067 <span class="preprocessor">#ifndef SEEK_END</span>
<a name="l00068"></a><a class="code" href="zip_8c.html#ad2a2e6c114780c3071efd24f16c7f7d8">00068</a> <span class="preprocessor"></span><span class="preprocessor">#define SEEK_END    2</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span>
<a name="l00071"></a>00071 <span class="preprocessor">#ifndef SEEK_SET</span>
<a name="l00072"></a><a class="code" href="zip_8c.html#a0d112bae8fd35be772185b6ec6bcbe64">00072</a> <span class="preprocessor"></span><span class="preprocessor">#define SEEK_SET    0</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span>
<a name="l00075"></a>00075 <span class="preprocessor">#ifndef DEF_MEM_LEVEL</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span><span class="preprocessor">#if MAX_MEM_LEVEL &gt;= 8</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span><span class="preprocessor">#  define DEF_MEM_LEVEL 8</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span><span class="preprocessor">#  define DEF_MEM_LEVEL  MAX_MEM_LEVEL</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00082"></a><a class="code" href="zip_8c.html#a2f04ce339195ade34f75dcba39524570">00082</a> <span class="preprocessor"></span><span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="zip_8c.html#a2f04ce339195ade34f75dcba39524570">zip_copyright</a>[] =
<a name="l00083"></a>00083    <span class="stringliteral">&quot; zip 1.01 Copyright 1998-2004 Gilles Vollant - http://www.winimage.com/zLibDll&quot;</span>;
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 
<a name="l00086"></a><a class="code" href="zip_8c.html#a836292d756d7119c390ac856b702ba82">00086</a> <span class="preprocessor">#define SIZEDATA_INDATABLOCK (4096-(4*4))</span>
<a name="l00087"></a>00087 <span class="preprocessor"></span>
<a name="l00088"></a><a class="code" href="zip_8c.html#a9341868e4dbaa2610fe54b599cd8965f">00088</a> <span class="preprocessor">#define LOCALHEADERMAGIC    (0x04034b50)</span>
<a name="l00089"></a><a class="code" href="zip_8c.html#a693b6919a7002d5d8f2030ea38bdb745">00089</a> <span class="preprocessor"></span><span class="preprocessor">#define CENTRALHEADERMAGIC  (0x02014b50)</span>
<a name="l00090"></a><a class="code" href="zip_8c.html#a919e00d5518c0ac9c5f46f7265d4c292">00090</a> <span class="preprocessor"></span><span class="preprocessor">#define ENDHEADERMAGIC      (0x06054b50)</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span>
<a name="l00092"></a><a class="code" href="zip_8c.html#a264fabfc0967e5c2e045a153599cbb75">00092</a> <span class="preprocessor">#define FLAG_LOCALHEADER_OFFSET (0x06)</span>
<a name="l00093"></a><a class="code" href="zip_8c.html#a49d8aae52c0ac93104210373043250e6">00093</a> <span class="preprocessor"></span><span class="preprocessor">#define CRC_LOCALHEADER_OFFSET  (0x0e)</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span>
<a name="l00095"></a><a class="code" href="zip_8c.html#a1d462da8349d0e3e53ecbaf284336066">00095</a> <span class="preprocessor">#define SIZECENTRALHEADER (0x2e) </span><span class="comment">/* 46 */</span>
<a name="l00096"></a>00096 
<a name="l00097"></a><a class="code" href="structlinkedlist__datablock__internal__s.html">00097</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structlinkedlist__datablock__internal__s.html">linkedlist_datablock_internal_s</a>
<a name="l00098"></a>00098 {
<a name="l00099"></a><a class="code" href="structlinkedlist__datablock__internal__s.html#a1f5abadbf41d82b8724a048a33c4c153">00099</a>   <span class="keyword">struct </span><a class="code" href="structlinkedlist__datablock__internal__s.html">linkedlist_datablock_internal_s</a>* <a class="code" href="structlinkedlist__datablock__internal__s.html#a1f5abadbf41d82b8724a048a33c4c153">next_datablock</a>;
<a name="l00100"></a><a class="code" href="structlinkedlist__datablock__internal__s.html#a1d63f75d88f05ee665221ccf618a57ed">00100</a>   <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>  <a class="code" href="structlinkedlist__datablock__internal__s.html#a1d63f75d88f05ee665221ccf618a57ed">avail_in_this_block</a>;
<a name="l00101"></a><a class="code" href="structlinkedlist__datablock__internal__s.html#a76ae854b6029e6617c7544d2eb311f77">00101</a>   <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>  <a class="code" href="structlinkedlist__datablock__internal__s.html#a76ae854b6029e6617c7544d2eb311f77">filled_in_this_block</a>;
<a name="l00102"></a><a class="code" href="structlinkedlist__datablock__internal__s.html#ae7275ad9d24cbe4f4c062f29abfb3b91">00102</a>   <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>  <a class="code" href="structlinkedlist__datablock__internal__s.html#ae7275ad9d24cbe4f4c062f29abfb3b91">unused</a>; <span class="comment">/* for future use and alignement */</span>
<a name="l00103"></a><a class="code" href="structlinkedlist__datablock__internal__s.html#a04900ee41fa2247a73b7570ec162bb1d">00103</a>   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structlinkedlist__datablock__internal__s.html#a04900ee41fa2247a73b7570ec162bb1d">data</a>[SIZEDATA_INDATABLOCK];
<a name="l00104"></a>00104 } <a class="code" href="structlinkedlist__datablock__internal__s.html">linkedlist_datablock_internal</a>;
<a name="l00105"></a>00105 
<a name="l00106"></a><a class="code" href="structlinkedlist__data__s.html">00106</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structlinkedlist__data__s.html">linkedlist_data_s</a>
<a name="l00107"></a>00107 {
<a name="l00108"></a><a class="code" href="structlinkedlist__data__s.html#aa0a9c876ad4a05aa5969d8888fb57cdb">00108</a>     <a class="code" href="structlinkedlist__datablock__internal__s.html">linkedlist_datablock_internal</a>* <a class="code" href="structlinkedlist__data__s.html#aa0a9c876ad4a05aa5969d8888fb57cdb">first_block</a>;
<a name="l00109"></a><a class="code" href="structlinkedlist__data__s.html#a26afdb5141483c909dafb8c5fd016bb8">00109</a>     <a class="code" href="structlinkedlist__datablock__internal__s.html">linkedlist_datablock_internal</a>* <a class="code" href="structlinkedlist__data__s.html#a26afdb5141483c909dafb8c5fd016bb8">last_block</a>;
<a name="l00110"></a>00110 } <a class="code" href="structlinkedlist__data__s.html">linkedlist_data</a>;
<a name="l00111"></a>00111 
<a name="l00112"></a>00112 
<a name="l00113"></a><a class="code" href="structcurfile__info.html">00113</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00114"></a>00114 {
<a name="l00115"></a><a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">00115</a>     z_stream stream;            <span class="comment">/* zLib stream structure for inflate */</span>
<a name="l00116"></a><a class="code" href="structcurfile__info.html#a4408645945defb3e3e72fd354d4e98b2">00116</a>     <span class="keywordtype">int</span>  stream_initialised;    <span class="comment">/* 1 is stream is initialised */</span>
<a name="l00117"></a><a class="code" href="structcurfile__info.html#ab1e433122ecceb389c8d258830e89f6f">00117</a>     uInt pos_in_buffered_data;  <span class="comment">/* last written byte in buffered_data */</span>
<a name="l00118"></a>00118 
<a name="l00119"></a><a class="code" href="structcurfile__info.html#ae859aac5711395f5136a26a393f4f3ec">00119</a>     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> pos_local_header;     <span class="comment">/* offset of the local header of the file</span>
<a name="l00120"></a>00120 <span class="comment">                                     currenty writing */</span>
<a name="l00121"></a><a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">00121</a>     <span class="keywordtype">char</span>* central_header;       <span class="comment">/* central header data for the current file */</span>
<a name="l00122"></a><a class="code" href="structcurfile__info.html#a25272deebbc7e9f5f474f4c2b36e27a6">00122</a>     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> size_centralheader;   <span class="comment">/* size of the central header for cur file */</span>
<a name="l00123"></a><a class="code" href="structcurfile__info.html#a9484e7dcce78fd7856e3048357115172">00123</a>     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> flag;                 <span class="comment">/* flag of the file currently writing */</span>
<a name="l00124"></a>00124 
<a name="l00125"></a><a class="code" href="structcurfile__info.html#ac69364c19c39e2962e8f247f4b760d5f">00125</a>     <span class="keywordtype">int</span>  method;                <span class="comment">/* compression method of file currenty wr.*/</span>
<a name="l00126"></a><a class="code" href="structcurfile__info.html#ab79a678fff8d4fb6e55f410d33a5d555">00126</a>     <span class="keywordtype">int</span>  raw;                   <span class="comment">/* 1 for directly writing raw data */</span>
<a name="l00127"></a><a class="code" href="structcurfile__info.html#a73ba705398941ee5d8f0cfc61df6b82d">00127</a>     Byte buffered_data[Z_BUFSIZE];<span class="comment">/* buffer contain compressed data to be writ*/</span>
<a name="l00128"></a><a class="code" href="structcurfile__info.html#afb63cc461b5237c76e41904ed9fb726a">00128</a>     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> dosDate;
<a name="l00129"></a><a class="code" href="structcurfile__info.html#ab58f6860a40fdaf0932d659d8743f876">00129</a>     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> crc32;
<a name="l00130"></a><a class="code" href="structcurfile__info.html#a5bc94d3a94e6ffe7f4e4783c668a263e">00130</a>     <span class="keywordtype">int</span>  encrypt;
<a name="l00131"></a>00131 <span class="preprocessor">#ifndef NOCRYPT</span>
<a name="l00132"></a><a class="code" href="structcurfile__info.html#ac6836b3fb49829e3490cae1e8e319ed6">00132</a> <span class="preprocessor"></span>    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> keys[3];     <span class="comment">/* keys defining the pseudo-random sequence */</span>
<a name="l00133"></a><a class="code" href="structcurfile__info.html#a9de6dd632a0a1eaad2729ae1f993fa71">00133</a>     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>* pcrc_32_tab;
<a name="l00134"></a><a class="code" href="structcurfile__info.html#aec9ef70b3fa0459612a2c2b5c8c2c4ea">00134</a>     <span class="keywordtype">int</span> crypt_header_size;
<a name="l00135"></a>00135 <span class="preprocessor">#endif</span>
<a name="l00136"></a>00136 <span class="preprocessor"></span>} <a class="code" href="structcurfile__info.html">curfile_info</a>;
<a name="l00137"></a>00137 
<a name="l00138"></a><a class="code" href="structzip__internal.html">00138</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00139"></a>00139 {
<a name="l00140"></a><a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">00140</a>     <a class="code" href="structzlib__filefunc__def__s.html">zlib_filefunc_def</a> z_filefunc;
<a name="l00141"></a><a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">00141</a>     <a class="code" href="ioapi_8h.html#a39ab6d73c1cd44bc17064c2dcbb3e753">voidpf</a> filestream;        <span class="comment">/* io structore of the zipfile */</span>
<a name="l00142"></a><a class="code" href="structzip__internal.html#ae63acf37b5a3719b3eae7802115ed73c">00142</a>     <a class="code" href="structlinkedlist__data__s.html">linkedlist_data</a> central_dir;<span class="comment">/* datablock with central dir in construction*/</span>
<a name="l00143"></a><a class="code" href="structzip__internal.html#a98dbf3927482a45adefcd32d12bd7840">00143</a>     <span class="keywordtype">int</span>  in_opened_file_inzip;  <span class="comment">/* 1 if a file in the zip is currently writ.*/</span>
<a name="l00144"></a><a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">00144</a>     <a class="code" href="structcurfile__info.html">curfile_info</a> ci;            <span class="comment">/* info on the file curretly writing */</span>
<a name="l00145"></a>00145 
<a name="l00146"></a><a class="code" href="structzip__internal.html#a913be8e62247a3fbe1ffcdf7c03d0248">00146</a>     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> begin_pos;            <span class="comment">/* position of the beginning of the zipfile */</span>
<a name="l00147"></a><a class="code" href="structzip__internal.html#a6cd048a07f19de1144c9a7edc3645422">00147</a>     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> add_position_when_writting_offset;
<a name="l00148"></a><a class="code" href="structzip__internal.html#a8415937c4a5b2afc0adde407d59f2750">00148</a>     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> number_entry;
<a name="l00149"></a>00149 <span class="preprocessor">#ifndef NO_ADDFILEINEXISTINGZIP</span>
<a name="l00150"></a><a class="code" href="structzip__internal.html#a8a49f83da0affc89cfc541ab38e72471">00150</a> <span class="preprocessor"></span>    <span class="keywordtype">char</span> *globalcomment;
<a name="l00151"></a>00151 <span class="preprocessor">#endif</span>
<a name="l00152"></a>00152 <span class="preprocessor"></span>} <a class="code" href="structzip__internal.html">zip_internal</a>;
<a name="l00153"></a>00153 
<a name="l00154"></a>00154 
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 <span class="preprocessor">#ifndef NOCRYPT</span>
<a name="l00157"></a><a class="code" href="zip_8c.html#aeef9f96d4641105f1c2f5e7d5a51c713">00157</a> <span class="preprocessor"></span><span class="preprocessor">#define INCLUDECRYPTINGCODE_IFCRYPTALLOWED</span>
<a name="l00158"></a>00158 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="crypt_8h.html">crypt.h</a>&quot;</span>
<a name="l00159"></a>00159 <span class="preprocessor">#endif</span>
<a name="l00160"></a>00160 <span class="preprocessor"></span>
<a name="l00161"></a><a class="code" href="zip_8c.html#a86c6b1ea8228286351584adc3d47b07c">00161</a> <a class="code" href="zip_8c.html#a08023ea6765c99d60a6a3840cd07156e">local</a> <a class="code" href="structlinkedlist__datablock__internal__s.html">linkedlist_datablock_internal</a>* <a class="code" href="zip_8c.html#a86c6b1ea8228286351584adc3d47b07c">allocate_new_datablock</a>()
<a name="l00162"></a>00162 {
<a name="l00163"></a>00163     <a class="code" href="structlinkedlist__datablock__internal__s.html">linkedlist_datablock_internal</a>* ldi;
<a name="l00164"></a>00164     ldi = (<a class="code" href="structlinkedlist__datablock__internal__s.html">linkedlist_datablock_internal</a>*)
<a name="l00165"></a>00165                  <a class="code" href="zip_8c.html#ac5c822e3692a95451e8f70a5916f05a3">ALLOC</a>(<span class="keyword">sizeof</span>(<a class="code" href="structlinkedlist__datablock__internal__s.html">linkedlist_datablock_internal</a>));
<a name="l00166"></a>00166     <span class="keywordflow">if</span> (ldi!=NULL)
<a name="l00167"></a>00167     {
<a name="l00168"></a>00168         ldi-&gt;<a class="code" href="structlinkedlist__datablock__internal__s.html#a1f5abadbf41d82b8724a048a33c4c153">next_datablock</a> = NULL ;
<a name="l00169"></a>00169         ldi-&gt;<a class="code" href="structlinkedlist__datablock__internal__s.html#a76ae854b6029e6617c7544d2eb311f77">filled_in_this_block</a> = 0 ;
<a name="l00170"></a>00170         ldi-&gt;<a class="code" href="structlinkedlist__datablock__internal__s.html#a1d63f75d88f05ee665221ccf618a57ed">avail_in_this_block</a> = SIZEDATA_INDATABLOCK ;
<a name="l00171"></a>00171     }
<a name="l00172"></a>00172     <span class="keywordflow">return</span> ldi;
<a name="l00173"></a>00173 }
<a name="l00174"></a>00174 
<a name="l00175"></a><a class="code" href="zip_8c.html#abef16e3f609c5691bab782908095af3b">00175</a> <a class="code" href="zip_8c.html#a08023ea6765c99d60a6a3840cd07156e">local</a> <span class="keywordtype">void</span> <a class="code" href="zip_8c.html#abef16e3f609c5691bab782908095af3b">free_datablock</a>(ldi)
<a name="l00176"></a>00176     <a class="code" href="structlinkedlist__datablock__internal__s.html">linkedlist_datablock_internal</a>* ldi;
<a name="l00177"></a>00177 {
<a name="l00178"></a>00178     <span class="keywordflow">while</span> (ldi!=NULL)
<a name="l00179"></a>00179     {
<a name="l00180"></a>00180         <a class="code" href="structlinkedlist__datablock__internal__s.html">linkedlist_datablock_internal</a>* ldinext = ldi-&gt;next_datablock;
<a name="l00181"></a>00181         <a class="code" href="zip_8c.html#a5fb23c00a00f3856832e660edc2ab03d">TRYFREE</a>(ldi);
<a name="l00182"></a>00182         ldi = ldinext;
<a name="l00183"></a>00183     }
<a name="l00184"></a>00184 }
<a name="l00185"></a>00185 
<a name="l00186"></a><a class="code" href="zip_8c.html#ab35cbb6cd12ca130a5f4443aeca7e43b">00186</a> <a class="code" href="zip_8c.html#a08023ea6765c99d60a6a3840cd07156e">local</a> <span class="keywordtype">void</span> <a class="code" href="zip_8c.html#ab35cbb6cd12ca130a5f4443aeca7e43b">init_linkedlist</a>(ll)
<a name="l00187"></a>00187     <a class="code" href="structlinkedlist__data__s.html">linkedlist_data</a>* ll;
<a name="l00188"></a>00188 {
<a name="l00189"></a>00189     ll-&gt;first_block = ll-&gt;last_block = NULL;
<a name="l00190"></a>00190 }
<a name="l00191"></a>00191 
<a name="l00192"></a><a class="code" href="zip_8c.html#a828b9b8e64fa414a46c5b9420c522caf">00192</a> <a class="code" href="zip_8c.html#a08023ea6765c99d60a6a3840cd07156e">local</a> <span class="keywordtype">void</span> <a class="code" href="zip_8c.html#a828b9b8e64fa414a46c5b9420c522caf">free_linkedlist</a>(ll)
<a name="l00193"></a>00193     <a class="code" href="structlinkedlist__data__s.html">linkedlist_data</a>* ll;
<a name="l00194"></a>00194 {
<a name="l00195"></a>00195     <a class="code" href="zip_8c.html#abef16e3f609c5691bab782908095af3b">free_datablock</a>(ll-&gt;first_block);
<a name="l00196"></a>00196     ll-&gt;first_block = ll-&gt;last_block = NULL;
<a name="l00197"></a>00197 }
<a name="l00198"></a>00198 
<a name="l00199"></a>00199 
<a name="l00200"></a><a class="code" href="zip_8c.html#af411f447b40db1fad258dee3b786ccc1">00200</a> <a class="code" href="zip_8c.html#a08023ea6765c99d60a6a3840cd07156e">local</a> <span class="keywordtype">int</span> <a class="code" href="zip_8c.html#af411f447b40db1fad258dee3b786ccc1">add_data_in_datablock</a>(ll,<a class="code" href="ioapi_8h.html#a8ad8a13c88886b9f623034ff88570adb">buf</a>,len)
<a name="l00201"></a>00201     <a class="code" href="structlinkedlist__data__s.html">linkedlist_data</a>* ll;
<a name="l00202"></a>00202     const <span class="keywordtype">void</span>* <a class="code" href="ioapi_8h.html#a8ad8a13c88886b9f623034ff88570adb">buf</a>;
<a name="l00203"></a>00203     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> len;
<a name="l00204"></a>00204 {
<a name="l00205"></a>00205     <a class="code" href="structlinkedlist__datablock__internal__s.html">linkedlist_datablock_internal</a>* ldi;
<a name="l00206"></a>00206     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* from_copy;
<a name="l00207"></a>00207 
<a name="l00208"></a>00208     <span class="keywordflow">if</span> (ll==NULL)
<a name="l00209"></a>00209         <span class="keywordflow">return</span> ZIP_INTERNALERROR;
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     <span class="keywordflow">if</span> (ll-&gt;last_block == NULL)
<a name="l00212"></a>00212     {
<a name="l00213"></a>00213         ll-&gt;first_block = ll-&gt;last_block = <a class="code" href="zip_8c.html#a86c6b1ea8228286351584adc3d47b07c">allocate_new_datablock</a>();
<a name="l00214"></a>00214         <span class="keywordflow">if</span> (ll-&gt;first_block == NULL)
<a name="l00215"></a>00215             <span class="keywordflow">return</span> ZIP_INTERNALERROR;
<a name="l00216"></a>00216     }
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     ldi = ll-&gt;last_block;
<a name="l00219"></a>00219     from_copy = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)buf;
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     <span class="keywordflow">while</span> (len&gt;0)
<a name="l00222"></a>00222     {
<a name="l00223"></a>00223         uInt copy_this;
<a name="l00224"></a>00224         uInt i;
<a name="l00225"></a>00225         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* to_copy;
<a name="l00226"></a>00226 
<a name="l00227"></a>00227         <span class="keywordflow">if</span> (ldi-&gt;<a class="code" href="structlinkedlist__datablock__internal__s.html#a1d63f75d88f05ee665221ccf618a57ed">avail_in_this_block</a>==0)
<a name="l00228"></a>00228         {
<a name="l00229"></a>00229             ldi-&gt;<a class="code" href="structlinkedlist__datablock__internal__s.html#a1f5abadbf41d82b8724a048a33c4c153">next_datablock</a> = <a class="code" href="zip_8c.html#a86c6b1ea8228286351584adc3d47b07c">allocate_new_datablock</a>();
<a name="l00230"></a>00230             <span class="keywordflow">if</span> (ldi-&gt;<a class="code" href="structlinkedlist__datablock__internal__s.html#a1f5abadbf41d82b8724a048a33c4c153">next_datablock</a> == NULL)
<a name="l00231"></a>00231                 <span class="keywordflow">return</span> ZIP_INTERNALERROR;
<a name="l00232"></a>00232             ldi = ldi-&gt;<a class="code" href="structlinkedlist__datablock__internal__s.html#a1f5abadbf41d82b8724a048a33c4c153">next_datablock</a> ;
<a name="l00233"></a>00233             ll-&gt;last_block = ldi;
<a name="l00234"></a>00234         }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236         <span class="keywordflow">if</span> (ldi-&gt;<a class="code" href="structlinkedlist__datablock__internal__s.html#a1d63f75d88f05ee665221ccf618a57ed">avail_in_this_block</a> &lt; len)
<a name="l00237"></a>00237             copy_this = (uInt)ldi-&gt;<a class="code" href="structlinkedlist__datablock__internal__s.html#a1d63f75d88f05ee665221ccf618a57ed">avail_in_this_block</a>;
<a name="l00238"></a>00238         <span class="keywordflow">else</span>
<a name="l00239"></a>00239             copy_this = (uInt)len;
<a name="l00240"></a>00240 
<a name="l00241"></a>00241         to_copy = &amp;(ldi-&gt;<a class="code" href="structlinkedlist__datablock__internal__s.html#a04900ee41fa2247a73b7570ec162bb1d">data</a>[ldi-&gt;<a class="code" href="structlinkedlist__datablock__internal__s.html#a76ae854b6029e6617c7544d2eb311f77">filled_in_this_block</a>]);
<a name="l00242"></a>00242 
<a name="l00243"></a>00243         <span class="keywordflow">for</span> (i=0;i&lt;copy_this;i++)
<a name="l00244"></a>00244             *(to_copy+i)=*(from_copy+i);
<a name="l00245"></a>00245 
<a name="l00246"></a>00246         ldi-&gt;<a class="code" href="structlinkedlist__datablock__internal__s.html#a76ae854b6029e6617c7544d2eb311f77">filled_in_this_block</a> += copy_this;
<a name="l00247"></a>00247         ldi-&gt;<a class="code" href="structlinkedlist__datablock__internal__s.html#a1d63f75d88f05ee665221ccf618a57ed">avail_in_this_block</a> -= copy_this;
<a name="l00248"></a>00248         from_copy += copy_this ;
<a name="l00249"></a>00249         len -= copy_this;
<a name="l00250"></a>00250     }
<a name="l00251"></a>00251     <span class="keywordflow">return</span> ZIP_OK;
<a name="l00252"></a>00252 }
<a name="l00253"></a>00253 
<a name="l00254"></a>00254 
<a name="l00255"></a>00255 
<a name="l00256"></a>00256 <span class="comment">/****************************************************************************/</span>
<a name="l00257"></a>00257 
<a name="l00258"></a>00258 <span class="preprocessor">#ifndef NO_ADDFILEINEXISTINGZIP</span>
<a name="l00259"></a>00259 <span class="preprocessor"></span><span class="comment">/* ===========================================================================</span>
<a name="l00260"></a>00260 <span class="comment">   Inputs a long in LSB order to the given file</span>
<a name="l00261"></a>00261 <span class="comment">   nbByte == 1, 2 or 4 (byte, short or long)</span>
<a name="l00262"></a>00262 <span class="comment">*/</span>
<a name="l00263"></a>00263 
<a name="l00264"></a>00264 <a class="code" href="zip_8c.html#a08023ea6765c99d60a6a3840cd07156e">local</a> <span class="keywordtype">int</span> <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a> <a class="code" href="ioapi_8c.html#a8fcb355d40e34a0cec85c1a9d6e0c0b7">OF</a>((<span class="keyword">const</span> <a class="code" href="structzlib__filefunc__def__s.html">zlib_filefunc_def</a>* pzlib_filefunc_def,
<a name="l00265"></a>00265                                 <a class="code" href="ioapi_8h.html#a39ab6d73c1cd44bc17064c2dcbb3e753">voidpf</a> filestream, <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> x, <span class="keywordtype">int</span> nbByte));
<a name="l00266"></a><a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">00266</a> <a class="code" href="zip_8c.html#a08023ea6765c99d60a6a3840cd07156e">local</a> <span class="keywordtype">int</span> <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a> (pzlib_filefunc_def, filestream, x, nbByte)
<a name="l00267"></a>00267     const <a class="code" href="structzlib__filefunc__def__s.html">zlib_filefunc_def</a>* pzlib_filefunc_def;
<a name="l00268"></a>00268     <a class="code" href="ioapi_8h.html#a39ab6d73c1cd44bc17064c2dcbb3e753">voidpf</a> filestream;
<a name="l00269"></a>00269     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> x;
<a name="l00270"></a>00270     <span class="keywordtype">int</span> nbByte;
<a name="l00271"></a>00271 {
<a name="l00272"></a>00272     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="ioapi_8h.html#a8ad8a13c88886b9f623034ff88570adb">buf</a>[4];
<a name="l00273"></a>00273     <span class="keywordtype">int</span> n;
<a name="l00274"></a>00274     <span class="keywordflow">for</span> (n = 0; n &lt; nbByte; n++)
<a name="l00275"></a>00275     {
<a name="l00276"></a>00276         buf[n] = (<span class="keywordtype">unsigned</span> char)(x &amp; 0xff);
<a name="l00277"></a>00277         x &gt;&gt;= 8;
<a name="l00278"></a>00278     }
<a name="l00279"></a>00279     <span class="keywordflow">if</span> (x != 0)
<a name="l00280"></a>00280       {     <span class="comment">/* data overflow - hack for ZIP64 (X Roche) */</span>
<a name="l00281"></a>00281       <span class="keywordflow">for</span> (n = 0; n &lt; nbByte; n++)
<a name="l00282"></a>00282         {
<a name="l00283"></a>00283           buf[n] = 0xff;
<a name="l00284"></a>00284         }
<a name="l00285"></a>00285       }
<a name="l00286"></a>00286 
<a name="l00287"></a>00287     <span class="keywordflow">if</span> (<a class="code" href="ioapi_8h.html#a440d7e7546b628b36ae22ab621d43d8c">ZWRITE</a>(*pzlib_filefunc_def,filestream,buf,nbByte)!=(uLong)nbByte)
<a name="l00288"></a>00288         <span class="keywordflow">return</span> ZIP_ERRNO;
<a name="l00289"></a>00289     <span class="keywordflow">else</span>
<a name="l00290"></a>00290         <span class="keywordflow">return</span> ZIP_OK;
<a name="l00291"></a>00291 }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293 <a class="code" href="zip_8c.html#a08023ea6765c99d60a6a3840cd07156e">local</a> <span class="keywordtype">void</span> <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a> <a class="code" href="ioapi_8c.html#a8fcb355d40e34a0cec85c1a9d6e0c0b7">OF</a>((<span class="keywordtype">void</span>* dest, <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> x, <span class="keywordtype">int</span> nbByte));
<a name="l00294"></a><a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">00294</a> <a class="code" href="zip_8c.html#a08023ea6765c99d60a6a3840cd07156e">local</a> <span class="keywordtype">void</span> <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a> (dest, x, nbByte)
<a name="l00295"></a>00295     void* dest;
<a name="l00296"></a>00296     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> x;
<a name="l00297"></a>00297     <span class="keywordtype">int</span> nbByte;
<a name="l00298"></a>00298 {
<a name="l00299"></a>00299     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* <a class="code" href="ioapi_8h.html#a8ad8a13c88886b9f623034ff88570adb">buf</a>=(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)dest;
<a name="l00300"></a>00300     <span class="keywordtype">int</span> n;
<a name="l00301"></a>00301     <span class="keywordflow">for</span> (n = 0; n &lt; nbByte; n++) {
<a name="l00302"></a>00302         buf[n] = (<span class="keywordtype">unsigned</span> char)(x &amp; 0xff);
<a name="l00303"></a>00303         x &gt;&gt;= 8;
<a name="l00304"></a>00304     }
<a name="l00305"></a>00305 
<a name="l00306"></a>00306     <span class="keywordflow">if</span> (x != 0)
<a name="l00307"></a>00307     {     <span class="comment">/* data overflow - hack for ZIP64 */</span>
<a name="l00308"></a>00308        <span class="keywordflow">for</span> (n = 0; n &lt; nbByte; n++)
<a name="l00309"></a>00309        {
<a name="l00310"></a>00310           buf[n] = 0xff;
<a name="l00311"></a>00311        }
<a name="l00312"></a>00312     }
<a name="l00313"></a>00313 }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315 <span class="comment">/****************************************************************************/</span>
<a name="l00316"></a>00316 
<a name="l00317"></a>00317 
<a name="l00318"></a><a class="code" href="zip_8c.html#ade96cb6f6a8e958347d2416c6825296c">00318</a> <a class="code" href="zip_8c.html#a08023ea6765c99d60a6a3840cd07156e">local</a> <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> <a class="code" href="zip_8c.html#ade96cb6f6a8e958347d2416c6825296c">ziplocal_TmzDateToDosDate</a>(ptm,dosDate)
<a name="l00319"></a>00319     const <a class="code" href="structtm__zip__s.html">tm_zip</a>* ptm;
<a name="l00320"></a>00320     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> dosDate;
<a name="l00321"></a>00321 {
<a name="l00322"></a>00322     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> year = (uLong)ptm-&gt;tm_year;
<a name="l00323"></a>00323     if (year&gt;1980)
<a name="l00324"></a>00324         year-=1980;
<a name="l00325"></a>00325     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (year&gt;80)
<a name="l00326"></a>00326         year-=80;
<a name="l00327"></a>00327     <span class="keywordflow">return</span>
<a name="l00328"></a>00328       (<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>) (((ptm-&gt;tm_mday) + (32 * (ptm-&gt;tm_mon+1)) + (512 * year)) &lt;&lt; 16) |
<a name="l00329"></a>00329         ((ptm-&gt;tm_sec/2) + (32* ptm-&gt;tm_min) + (2048 * (uLong)ptm-&gt;tm_hour));
<a name="l00330"></a>00330 }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332 
<a name="l00333"></a>00333 <span class="comment">/****************************************************************************/</span>
<a name="l00334"></a>00334 
<a name="l00335"></a>00335 <a class="code" href="zip_8c.html#a08023ea6765c99d60a6a3840cd07156e">local</a> <span class="keywordtype">int</span> <a class="code" href="zip_8c.html#ac535025c7ad3c3c0f928fceb7bc3e81f">ziplocal_getByte</a> <a class="code" href="ioapi_8c.html#a8fcb355d40e34a0cec85c1a9d6e0c0b7">OF</a>((
<a name="l00336"></a>00336     <span class="keyword">const</span> <a class="code" href="structzlib__filefunc__def__s.html">zlib_filefunc_def</a>* pzlib_filefunc_def,
<a name="l00337"></a>00337     <a class="code" href="ioapi_8h.html#a39ab6d73c1cd44bc17064c2dcbb3e753">voidpf</a> filestream,
<a name="l00338"></a>00338     <span class="keywordtype">int</span> *pi));
<a name="l00339"></a>00339 
<a name="l00340"></a><a class="code" href="zip_8c.html#ac535025c7ad3c3c0f928fceb7bc3e81f">00340</a> <a class="code" href="zip_8c.html#a08023ea6765c99d60a6a3840cd07156e">local</a> <span class="keywordtype">int</span> <a class="code" href="zip_8c.html#ac535025c7ad3c3c0f928fceb7bc3e81f">ziplocal_getByte</a>(pzlib_filefunc_def,filestream,pi)
<a name="l00341"></a>00341     const <a class="code" href="structzlib__filefunc__def__s.html">zlib_filefunc_def</a>* pzlib_filefunc_def;
<a name="l00342"></a>00342     <a class="code" href="ioapi_8h.html#a39ab6d73c1cd44bc17064c2dcbb3e753">voidpf</a> filestream;
<a name="l00343"></a>00343     <span class="keywordtype">int</span> *pi;
<a name="l00344"></a>00344 {
<a name="l00345"></a>00345     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c;
<a name="l00346"></a>00346     <span class="keywordtype">int</span> err = (int)<a class="code" href="ioapi_8h.html#ad59236c559eb21dbdc40f86d2e97d65d">ZREAD</a>(*pzlib_filefunc_def,filestream,&amp;c,1);
<a name="l00347"></a>00347     <span class="keywordflow">if</span> (err==1)
<a name="l00348"></a>00348     {
<a name="l00349"></a>00349         *pi = (int)c;
<a name="l00350"></a>00350         <span class="keywordflow">return</span> ZIP_OK;
<a name="l00351"></a>00351     }
<a name="l00352"></a>00352     <span class="keywordflow">else</span>
<a name="l00353"></a>00353     {
<a name="l00354"></a>00354         <span class="keywordflow">if</span> (<a class="code" href="ioapi_8h.html#ac2c1539d88acceb31040e20b85ce2d6c">ZERROR</a>(*pzlib_filefunc_def,filestream))
<a name="l00355"></a>00355             <span class="keywordflow">return</span> <a class="code" href="zip_8h.html#a94d5d490eddae7316ed282729fdc4bf2">ZIP_ERRNO</a>;
<a name="l00356"></a>00356         <span class="keywordflow">else</span>
<a name="l00357"></a>00357             <span class="keywordflow">return</span> ZIP_EOF;
<a name="l00358"></a>00358     }
<a name="l00359"></a>00359 }
<a name="l00360"></a>00360 
<a name="l00361"></a>00361 
<a name="l00362"></a>00362 <span class="comment">/* ===========================================================================</span>
<a name="l00363"></a>00363 <span class="comment">   Reads a long in LSB order from the given gz_stream. Sets</span>
<a name="l00364"></a>00364 <span class="comment">*/</span>
<a name="l00365"></a>00365 <a class="code" href="zip_8c.html#a08023ea6765c99d60a6a3840cd07156e">local</a> <span class="keywordtype">int</span> <a class="code" href="zip_8c.html#ac1d0eaea6f45e086e00b8ef00cef53cf">ziplocal_getShort</a> <a class="code" href="ioapi_8c.html#a8fcb355d40e34a0cec85c1a9d6e0c0b7">OF</a>((
<a name="l00366"></a>00366     <span class="keyword">const</span> <a class="code" href="structzlib__filefunc__def__s.html">zlib_filefunc_def</a>* pzlib_filefunc_def,
<a name="l00367"></a>00367     <a class="code" href="ioapi_8h.html#a39ab6d73c1cd44bc17064c2dcbb3e753">voidpf</a> filestream,
<a name="l00368"></a>00368     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> *pX));
<a name="l00369"></a>00369 
<a name="l00370"></a><a class="code" href="zip_8c.html#ac1d0eaea6f45e086e00b8ef00cef53cf">00370</a> <a class="code" href="zip_8c.html#a08023ea6765c99d60a6a3840cd07156e">local</a> <span class="keywordtype">int</span> <a class="code" href="zip_8c.html#ac1d0eaea6f45e086e00b8ef00cef53cf">ziplocal_getShort</a> (pzlib_filefunc_def,filestream,pX)
<a name="l00371"></a>00371     const <a class="code" href="structzlib__filefunc__def__s.html">zlib_filefunc_def</a>* pzlib_filefunc_def;
<a name="l00372"></a>00372     <a class="code" href="ioapi_8h.html#a39ab6d73c1cd44bc17064c2dcbb3e753">voidpf</a> filestream;
<a name="l00373"></a>00373     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> *pX;
<a name="l00374"></a>00374 {
<a name="l00375"></a>00375     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> x ;
<a name="l00376"></a>00376     <span class="keywordtype">int</span> i;
<a name="l00377"></a>00377     <span class="keywordtype">int</span> err;
<a name="l00378"></a>00378 
<a name="l00379"></a>00379     err = <a class="code" href="zip_8c.html#ac535025c7ad3c3c0f928fceb7bc3e81f">ziplocal_getByte</a>(pzlib_filefunc_def,filestream,&amp;i);
<a name="l00380"></a>00380     x = (uLong)i;
<a name="l00381"></a>00381 
<a name="l00382"></a>00382     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00383"></a>00383         err = <a class="code" href="zip_8c.html#ac535025c7ad3c3c0f928fceb7bc3e81f">ziplocal_getByte</a>(pzlib_filefunc_def,filestream,&amp;i);
<a name="l00384"></a>00384     x += ((uLong)i)&lt;&lt;8;
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00387"></a>00387         *pX = x;
<a name="l00388"></a>00388     <span class="keywordflow">else</span>
<a name="l00389"></a>00389         *pX = 0;
<a name="l00390"></a>00390     <span class="keywordflow">return</span> err;
<a name="l00391"></a>00391 }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393 <a class="code" href="zip_8c.html#a08023ea6765c99d60a6a3840cd07156e">local</a> <span class="keywordtype">int</span> <a class="code" href="zip_8c.html#a6bb96bf76fc9e8af6ad80c5f5585e89d">ziplocal_getLong</a> <a class="code" href="ioapi_8c.html#a8fcb355d40e34a0cec85c1a9d6e0c0b7">OF</a>((
<a name="l00394"></a>00394     <span class="keyword">const</span> <a class="code" href="structzlib__filefunc__def__s.html">zlib_filefunc_def</a>* pzlib_filefunc_def,
<a name="l00395"></a>00395     <a class="code" href="ioapi_8h.html#a39ab6d73c1cd44bc17064c2dcbb3e753">voidpf</a> filestream,
<a name="l00396"></a>00396     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> *pX));
<a name="l00397"></a>00397 
<a name="l00398"></a><a class="code" href="zip_8c.html#a6bb96bf76fc9e8af6ad80c5f5585e89d">00398</a> <a class="code" href="zip_8c.html#a08023ea6765c99d60a6a3840cd07156e">local</a> <span class="keywordtype">int</span> <a class="code" href="zip_8c.html#a6bb96bf76fc9e8af6ad80c5f5585e89d">ziplocal_getLong</a> (pzlib_filefunc_def,filestream,pX)
<a name="l00399"></a>00399     const <a class="code" href="structzlib__filefunc__def__s.html">zlib_filefunc_def</a>* pzlib_filefunc_def;
<a name="l00400"></a>00400     <a class="code" href="ioapi_8h.html#a39ab6d73c1cd44bc17064c2dcbb3e753">voidpf</a> filestream;
<a name="l00401"></a>00401     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> *pX;
<a name="l00402"></a>00402 {
<a name="l00403"></a>00403     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> x ;
<a name="l00404"></a>00404     <span class="keywordtype">int</span> i;
<a name="l00405"></a>00405     <span class="keywordtype">int</span> err;
<a name="l00406"></a>00406 
<a name="l00407"></a>00407     err = <a class="code" href="zip_8c.html#ac535025c7ad3c3c0f928fceb7bc3e81f">ziplocal_getByte</a>(pzlib_filefunc_def,filestream,&amp;i);
<a name="l00408"></a>00408     x = (uLong)i;
<a name="l00409"></a>00409 
<a name="l00410"></a>00410     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00411"></a>00411         err = <a class="code" href="zip_8c.html#ac535025c7ad3c3c0f928fceb7bc3e81f">ziplocal_getByte</a>(pzlib_filefunc_def,filestream,&amp;i);
<a name="l00412"></a>00412     x += ((uLong)i)&lt;&lt;8;
<a name="l00413"></a>00413 
<a name="l00414"></a>00414     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00415"></a>00415         err = <a class="code" href="zip_8c.html#ac535025c7ad3c3c0f928fceb7bc3e81f">ziplocal_getByte</a>(pzlib_filefunc_def,filestream,&amp;i);
<a name="l00416"></a>00416     x += ((uLong)i)&lt;&lt;16;
<a name="l00417"></a>00417 
<a name="l00418"></a>00418     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00419"></a>00419         err = <a class="code" href="zip_8c.html#ac535025c7ad3c3c0f928fceb7bc3e81f">ziplocal_getByte</a>(pzlib_filefunc_def,filestream,&amp;i);
<a name="l00420"></a>00420     x += ((uLong)i)&lt;&lt;24;
<a name="l00421"></a>00421 
<a name="l00422"></a>00422     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00423"></a>00423         *pX = x;
<a name="l00424"></a>00424     <span class="keywordflow">else</span>
<a name="l00425"></a>00425         *pX = 0;
<a name="l00426"></a>00426     <span class="keywordflow">return</span> err;
<a name="l00427"></a>00427 }
<a name="l00428"></a>00428 
<a name="l00429"></a>00429 <span class="preprocessor">#ifndef BUFREADCOMMENT</span>
<a name="l00430"></a><a class="code" href="zip_8c.html#a11acfc377461094b27681612f0bd277d">00430</a> <span class="preprocessor"></span><span class="preprocessor">#define BUFREADCOMMENT (0x400)</span>
<a name="l00431"></a>00431 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00432"></a>00432 <span class="preprocessor"></span><span class="comment">/*</span>
<a name="l00433"></a>00433 <span class="comment">  Locate the Central directory of a zipfile (at the end, just before</span>
<a name="l00434"></a>00434 <span class="comment">    the global comment)</span>
<a name="l00435"></a>00435 <span class="comment">*/</span>
<a name="l00436"></a>00436 <a class="code" href="zip_8c.html#a08023ea6765c99d60a6a3840cd07156e">local</a> <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> <a class="code" href="zip_8c.html#ac159dd6d503fa01c50ae69eda9e52c90">ziplocal_SearchCentralDir</a> <a class="code" href="ioapi_8c.html#a8fcb355d40e34a0cec85c1a9d6e0c0b7">OF</a>((
<a name="l00437"></a>00437     <span class="keyword">const</span> <a class="code" href="structzlib__filefunc__def__s.html">zlib_filefunc_def</a>* pzlib_filefunc_def,
<a name="l00438"></a>00438     <a class="code" href="ioapi_8h.html#a39ab6d73c1cd44bc17064c2dcbb3e753">voidpf</a> filestream));
<a name="l00439"></a>00439 
<a name="l00440"></a><a class="code" href="zip_8c.html#ac159dd6d503fa01c50ae69eda9e52c90">00440</a> <a class="code" href="zip_8c.html#a08023ea6765c99d60a6a3840cd07156e">local</a> <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> <a class="code" href="zip_8c.html#ac159dd6d503fa01c50ae69eda9e52c90">ziplocal_SearchCentralDir</a>(pzlib_filefunc_def,filestream)
<a name="l00441"></a>00441     const <a class="code" href="structzlib__filefunc__def__s.html">zlib_filefunc_def</a>* pzlib_filefunc_def;
<a name="l00442"></a>00442     <a class="code" href="ioapi_8h.html#a39ab6d73c1cd44bc17064c2dcbb3e753">voidpf</a> filestream;
<a name="l00443"></a>00443 {
<a name="l00444"></a>00444     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* buf;
<a name="l00445"></a>00445     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> uSizeFile;
<a name="l00446"></a>00446     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> uBackRead;
<a name="l00447"></a>00447     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> uMaxBack=0xffff; <span class="comment">/* maximum size of global comment */</span>
<a name="l00448"></a>00448     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> uPosFound=0;
<a name="l00449"></a>00449 
<a name="l00450"></a>00450     <span class="keywordflow">if</span> (<a class="code" href="ioapi_8h.html#a150463ba2515263515f68599c580b64e">ZSEEK</a>(*pzlib_filefunc_def,filestream,0,<a class="code" href="ioapi_8h.html#ace27d6d19b1005424d1fb4bd0c7c9602">ZLIB_FILEFUNC_SEEK_END</a>) != 0)
<a name="l00451"></a>00451         <span class="keywordflow">return</span> 0;
<a name="l00452"></a>00452 
<a name="l00453"></a>00453 
<a name="l00454"></a>00454     uSizeFile = <a class="code" href="ioapi_8h.html#a6010b5be81cd016bf0fe649cea4cf2c2">ZTELL</a>(*pzlib_filefunc_def,filestream);
<a name="l00455"></a>00455 
<a name="l00456"></a>00456     <span class="keywordflow">if</span> (uMaxBack&gt;uSizeFile)
<a name="l00457"></a>00457         uMaxBack = uSizeFile;
<a name="l00458"></a>00458 
<a name="l00459"></a>00459     buf = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)<a class="code" href="zip_8c.html#ac5c822e3692a95451e8f70a5916f05a3">ALLOC</a>(<a class="code" href="zip_8c.html#a11acfc377461094b27681612f0bd277d">BUFREADCOMMENT</a>+4);
<a name="l00460"></a>00460     <span class="keywordflow">if</span> (buf==NULL)
<a name="l00461"></a>00461         <span class="keywordflow">return</span> 0;
<a name="l00462"></a>00462 
<a name="l00463"></a>00463     uBackRead = 4;
<a name="l00464"></a>00464     <span class="keywordflow">while</span> (uBackRead&lt;uMaxBack)
<a name="l00465"></a>00465     {
<a name="l00466"></a>00466         <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> uReadSize,uReadPos ;
<a name="l00467"></a>00467         <span class="keywordtype">int</span> i;
<a name="l00468"></a>00468         <span class="keywordflow">if</span> (uBackRead+<a class="code" href="zip_8c.html#a11acfc377461094b27681612f0bd277d">BUFREADCOMMENT</a>&gt;uMaxBack)
<a name="l00469"></a>00469             uBackRead = uMaxBack;
<a name="l00470"></a>00470         <span class="keywordflow">else</span>
<a name="l00471"></a>00471             uBackRead+=BUFREADCOMMENT;
<a name="l00472"></a>00472         uReadPos = uSizeFile-uBackRead ;
<a name="l00473"></a>00473 
<a name="l00474"></a>00474         uReadSize = ((<a class="code" href="zip_8c.html#a11acfc377461094b27681612f0bd277d">BUFREADCOMMENT</a>+4) &lt; (uSizeFile-uReadPos)) ?
<a name="l00475"></a>00475                      (<a class="code" href="zip_8c.html#a11acfc377461094b27681612f0bd277d">BUFREADCOMMENT</a>+4) : (uSizeFile-uReadPos);
<a name="l00476"></a>00476         <span class="keywordflow">if</span> (<a class="code" href="ioapi_8h.html#a150463ba2515263515f68599c580b64e">ZSEEK</a>(*pzlib_filefunc_def,filestream,uReadPos,<a class="code" href="ioapi_8h.html#a962e25bd3652f31479b855be08836c16">ZLIB_FILEFUNC_SEEK_SET</a>)!=0)
<a name="l00477"></a>00477             <span class="keywordflow">break</span>;
<a name="l00478"></a>00478 
<a name="l00479"></a>00479         <span class="keywordflow">if</span> (<a class="code" href="ioapi_8h.html#ad59236c559eb21dbdc40f86d2e97d65d">ZREAD</a>(*pzlib_filefunc_def,filestream,buf,uReadSize)!=uReadSize)
<a name="l00480"></a>00480             <span class="keywordflow">break</span>;
<a name="l00481"></a>00481 
<a name="l00482"></a>00482         <span class="keywordflow">for</span> (i=(<span class="keywordtype">int</span>)uReadSize-3; (i--)&gt;0;)
<a name="l00483"></a>00483             <span class="keywordflow">if</span> (((*(buf+i))==0x50) &amp;&amp; ((*(buf+i+1))==0x4b) &amp;&amp;
<a name="l00484"></a>00484                 ((*(buf+i+2))==0x05) &amp;&amp; ((*(buf+i+3))==0x06))
<a name="l00485"></a>00485             {
<a name="l00486"></a>00486                 uPosFound = uReadPos+i;
<a name="l00487"></a>00487                 <span class="keywordflow">break</span>;
<a name="l00488"></a>00488             }
<a name="l00489"></a>00489 
<a name="l00490"></a>00490         <span class="keywordflow">if</span> (uPosFound!=0)
<a name="l00491"></a>00491             <span class="keywordflow">break</span>;
<a name="l00492"></a>00492     }
<a name="l00493"></a>00493     <a class="code" href="zip_8c.html#a5fb23c00a00f3856832e660edc2ab03d">TRYFREE</a>(buf);
<a name="l00494"></a>00494     <span class="keywordflow">return</span> uPosFound;
<a name="l00495"></a>00495 }
<a name="l00496"></a>00496 <span class="preprocessor">#endif </span><span class="comment">/* !NO_ADDFILEINEXISTINGZIP*/</span>
<a name="l00497"></a>00497 
<a name="l00498"></a>00498 <span class="comment">/************************************************************/</span>
<a name="l00499"></a><a class="code" href="zip_8c.html#a1e81b9e717c86e8c7ef8914534cd83e1">00499</a> <span class="keyword">extern</span> <a class="code" href="zip_8h.html#af69b9a5ea9aaf8e8f0b7681e451b224c">zipFile</a> ZEXPORT <a class="code" href="zip_8c.html#a1e81b9e717c86e8c7ef8914534cd83e1">zipOpen2</a> (pathname, append, globalcomment, pzlib_filefunc_def)
<a name="l00500"></a>00500     const <span class="keywordtype">char</span> *pathname;
<a name="l00501"></a>00501     <span class="keywordtype">int</span> append;
<a name="l00502"></a>00502     <a class="code" href="zip_8h.html#a3fb78711550861eb5b72cff21f1b1a84">zipcharpc</a>* globalcomment;
<a name="l00503"></a>00503     <a class="code" href="structzlib__filefunc__def__s.html">zlib_filefunc_def</a>* pzlib_filefunc_def;
<a name="l00504"></a>00504 {
<a name="l00505"></a>00505     <a class="code" href="structzip__internal.html">zip_internal</a> ziinit;
<a name="l00506"></a>00506     <a class="code" href="structzip__internal.html">zip_internal</a>* zi;
<a name="l00507"></a>00507     <span class="keywordtype">int</span> err=ZIP_OK;
<a name="l00508"></a>00508 
<a name="l00509"></a>00509 
<a name="l00510"></a>00510     <span class="keywordflow">if</span> (pzlib_filefunc_def==NULL)
<a name="l00511"></a>00511         <a class="code" href="ioapi_8c.html#ab44f1d585b26ce7f9447a91ada432727">fill_fopen_filefunc</a>(&amp;ziinit.<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>);
<a name="l00512"></a>00512     <span class="keywordflow">else</span>
<a name="l00513"></a>00513         ziinit.<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a> = *pzlib_filefunc_def;
<a name="l00514"></a>00514 
<a name="l00515"></a>00515     ziinit.<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a> = (*(ziinit.<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>.<a class="code" href="structzlib__filefunc__def__s.html#a49b78a559140e495b94af4d9dfe5c4e9">zopen_file</a>))
<a name="l00516"></a>00516                  (ziinit.<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>.<a class="code" href="structzlib__filefunc__def__s.html#a494b6d634b61bdc7fc7caed8e4fbe3f4">opaque</a>,
<a name="l00517"></a>00517                   pathname,
<a name="l00518"></a>00518                   (append == APPEND_STATUS_CREATE) ?
<a name="l00519"></a>00519                   (<a class="code" href="ioapi_8h.html#ae7bc575ca0cef5d90c7d5d093137d901">ZLIB_FILEFUNC_MODE_READ</a> | <a class="code" href="ioapi_8h.html#acb1ad2741eafcd1541c22553225146c6">ZLIB_FILEFUNC_MODE_WRITE</a> | <a class="code" href="ioapi_8h.html#aca55322d595862ec1c298ec87e8ea225">ZLIB_FILEFUNC_MODE_CREATE</a>) :
<a name="l00520"></a>00520                     (<a class="code" href="ioapi_8h.html#ae7bc575ca0cef5d90c7d5d093137d901">ZLIB_FILEFUNC_MODE_READ</a> | <a class="code" href="ioapi_8h.html#acb1ad2741eafcd1541c22553225146c6">ZLIB_FILEFUNC_MODE_WRITE</a> | ZLIB_FILEFUNC_MODE_EXISTING));
<a name="l00521"></a>00521 
<a name="l00522"></a>00522     <span class="keywordflow">if</span> (ziinit.<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a> == NULL)
<a name="l00523"></a>00523         <span class="keywordflow">return</span> NULL;
<a name="l00524"></a>00524     ziinit.<a class="code" href="structzip__internal.html#a913be8e62247a3fbe1ffcdf7c03d0248">begin_pos</a> = <a class="code" href="ioapi_8h.html#a6010b5be81cd016bf0fe649cea4cf2c2">ZTELL</a>(ziinit.<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,ziinit.<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>);
<a name="l00525"></a>00525     ziinit.<a class="code" href="structzip__internal.html#a98dbf3927482a45adefcd32d12bd7840">in_opened_file_inzip</a> = 0;
<a name="l00526"></a>00526     ziinit.<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a4408645945defb3e3e72fd354d4e98b2">stream_initialised</a> = 0;
<a name="l00527"></a>00527     ziinit.<a class="code" href="structzip__internal.html#a8415937c4a5b2afc0adde407d59f2750">number_entry</a> = 0;
<a name="l00528"></a>00528     ziinit.<a class="code" href="structzip__internal.html#a6cd048a07f19de1144c9a7edc3645422">add_position_when_writting_offset</a> = 0;
<a name="l00529"></a>00529     <a class="code" href="zip_8c.html#ab35cbb6cd12ca130a5f4443aeca7e43b">init_linkedlist</a>(&amp;(ziinit.<a class="code" href="structzip__internal.html#ae63acf37b5a3719b3eae7802115ed73c">central_dir</a>));
<a name="l00530"></a>00530 
<a name="l00531"></a>00531 
<a name="l00532"></a>00532     zi = (<a class="code" href="structzip__internal.html">zip_internal</a>*)<a class="code" href="zip_8c.html#ac5c822e3692a95451e8f70a5916f05a3">ALLOC</a>(<span class="keyword">sizeof</span>(<a class="code" href="structzip__internal.html">zip_internal</a>));
<a name="l00533"></a>00533     <span class="keywordflow">if</span> (zi==NULL)
<a name="l00534"></a>00534     {
<a name="l00535"></a>00535         <a class="code" href="ioapi_8h.html#a715986c0415785fdc35877402429a366">ZCLOSE</a>(ziinit.<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,ziinit.<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>);
<a name="l00536"></a>00536         <span class="keywordflow">return</span> NULL;
<a name="l00537"></a>00537     }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539     <span class="comment">/* now we add file in a zipfile */</span>
<a name="l00540"></a>00540 <span class="preprocessor">#    ifndef NO_ADDFILEINEXISTINGZIP</span>
<a name="l00541"></a>00541 <span class="preprocessor"></span>    ziinit.<a class="code" href="structzip__internal.html#a8a49f83da0affc89cfc541ab38e72471">globalcomment</a> = NULL;
<a name="l00542"></a>00542     <span class="keywordflow">if</span> (append == <a class="code" href="zip_8h.html#a3192cdd1a42f50096c341c48edb905a5">APPEND_STATUS_ADDINZIP</a>)
<a name="l00543"></a>00543     {
<a name="l00544"></a>00544         <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> byte_before_the_zipfile;<span class="comment">/* byte before the zipfile, (&gt;0 for sfx)*/</span>
<a name="l00545"></a>00545 
<a name="l00546"></a>00546         <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> size_central_dir;     <span class="comment">/* size of the central directory  */</span>
<a name="l00547"></a>00547         <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> offset_central_dir;   <span class="comment">/* offset of start of central directory */</span>
<a name="l00548"></a>00548         <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> central_pos,uL;
<a name="l00549"></a>00549 
<a name="l00550"></a>00550         <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> number_disk;          <span class="comment">/* number of the current dist, used for</span>
<a name="l00551"></a>00551 <span class="comment">                                    spaning ZIP, unsupported, always 0*/</span>
<a name="l00552"></a>00552         <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> number_disk_with_CD;  <span class="comment">/* number the the disk with central dir, used</span>
<a name="l00553"></a>00553 <span class="comment">                                    for spaning ZIP, unsupported, always 0*/</span>
<a name="l00554"></a>00554         <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> number_entry;
<a name="l00555"></a>00555         <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> number_entry_CD;      <span class="comment">/* total number of entries in</span>
<a name="l00556"></a>00556 <span class="comment">                                    the central dir</span>
<a name="l00557"></a>00557 <span class="comment">                                    (same than number_entry on nospan) */</span>
<a name="l00558"></a>00558         <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> size_comment;
<a name="l00559"></a>00559 
<a name="l00560"></a>00560         central_pos = <a class="code" href="zip_8c.html#ac159dd6d503fa01c50ae69eda9e52c90">ziplocal_SearchCentralDir</a>(&amp;ziinit.<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,ziinit.<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>);
<a name="l00561"></a>00561         <span class="keywordflow">if</span> (central_pos==0)
<a name="l00562"></a>00562             err=ZIP_ERRNO;
<a name="l00563"></a>00563 
<a name="l00564"></a>00564         <span class="keywordflow">if</span> (<a class="code" href="ioapi_8h.html#a150463ba2515263515f68599c580b64e">ZSEEK</a>(ziinit.<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>, ziinit.<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,
<a name="l00565"></a>00565                                         central_pos,<a class="code" href="ioapi_8h.html#a962e25bd3652f31479b855be08836c16">ZLIB_FILEFUNC_SEEK_SET</a>)!=0)
<a name="l00566"></a>00566             err=ZIP_ERRNO;
<a name="l00567"></a>00567 
<a name="l00568"></a>00568         <span class="comment">/* the signature, already checked */</span>
<a name="l00569"></a>00569         <span class="keywordflow">if</span> (<a class="code" href="zip_8c.html#a6bb96bf76fc9e8af6ad80c5f5585e89d">ziplocal_getLong</a>(&amp;ziinit.<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>, ziinit.<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,&amp;uL)!=<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00570"></a>00570             err=ZIP_ERRNO;
<a name="l00571"></a>00571 
<a name="l00572"></a>00572         <span class="comment">/* number of this disk */</span>
<a name="l00573"></a>00573         <span class="keywordflow">if</span> (<a class="code" href="zip_8c.html#ac1d0eaea6f45e086e00b8ef00cef53cf">ziplocal_getShort</a>(&amp;ziinit.<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>, ziinit.<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,&amp;number_disk)!=<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00574"></a>00574             err=ZIP_ERRNO;
<a name="l00575"></a>00575 
<a name="l00576"></a>00576         <span class="comment">/* number of the disk with the start of the central directory */</span>
<a name="l00577"></a>00577         <span class="keywordflow">if</span> (<a class="code" href="zip_8c.html#ac1d0eaea6f45e086e00b8ef00cef53cf">ziplocal_getShort</a>(&amp;ziinit.<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>, ziinit.<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,&amp;number_disk_with_CD)!=<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00578"></a>00578             err=ZIP_ERRNO;
<a name="l00579"></a>00579 
<a name="l00580"></a>00580         <span class="comment">/* total number of entries in the central dir on this disk */</span>
<a name="l00581"></a>00581         <span class="keywordflow">if</span> (<a class="code" href="zip_8c.html#ac1d0eaea6f45e086e00b8ef00cef53cf">ziplocal_getShort</a>(&amp;ziinit.<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>, ziinit.<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,&amp;number_entry)!=<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00582"></a>00582             err=ZIP_ERRNO;
<a name="l00583"></a>00583 
<a name="l00584"></a>00584         <span class="comment">/* total number of entries in the central dir */</span>
<a name="l00585"></a>00585         <span class="keywordflow">if</span> (<a class="code" href="zip_8c.html#ac1d0eaea6f45e086e00b8ef00cef53cf">ziplocal_getShort</a>(&amp;ziinit.<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>, ziinit.<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,&amp;number_entry_CD)!=<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00586"></a>00586             err=ZIP_ERRNO;
<a name="l00587"></a>00587 
<a name="l00588"></a>00588         <span class="keywordflow">if</span> ((number_entry_CD!=number_entry) ||
<a name="l00589"></a>00589             (number_disk_with_CD!=0) ||
<a name="l00590"></a>00590             (number_disk!=0))
<a name="l00591"></a>00591             err=ZIP_BADZIPFILE;
<a name="l00592"></a>00592 
<a name="l00593"></a>00593         <span class="comment">/* size of the central directory */</span>
<a name="l00594"></a>00594         <span class="keywordflow">if</span> (<a class="code" href="zip_8c.html#a6bb96bf76fc9e8af6ad80c5f5585e89d">ziplocal_getLong</a>(&amp;ziinit.<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>, ziinit.<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,&amp;size_central_dir)!=<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00595"></a>00595             err=ZIP_ERRNO;
<a name="l00596"></a>00596 
<a name="l00597"></a>00597         <span class="comment">/* offset of start of central directory with respect to the</span>
<a name="l00598"></a>00598 <span class="comment">            starting disk number */</span>
<a name="l00599"></a>00599         <span class="keywordflow">if</span> (<a class="code" href="zip_8c.html#a6bb96bf76fc9e8af6ad80c5f5585e89d">ziplocal_getLong</a>(&amp;ziinit.<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>, ziinit.<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,&amp;offset_central_dir)!=<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00600"></a>00600             err=ZIP_ERRNO;
<a name="l00601"></a>00601 
<a name="l00602"></a>00602         <span class="comment">/* zipfile global comment length */</span>
<a name="l00603"></a>00603         <span class="keywordflow">if</span> (<a class="code" href="zip_8c.html#ac1d0eaea6f45e086e00b8ef00cef53cf">ziplocal_getShort</a>(&amp;ziinit.<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>, ziinit.<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,&amp;size_comment)!=<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00604"></a>00604             err=ZIP_ERRNO;
<a name="l00605"></a>00605 
<a name="l00606"></a>00606         <span class="keywordflow">if</span> ((central_pos&lt;offset_central_dir+size_central_dir) &amp;&amp;
<a name="l00607"></a>00607             (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>))
<a name="l00608"></a>00608             err=ZIP_BADZIPFILE;
<a name="l00609"></a>00609 
<a name="l00610"></a>00610         <span class="keywordflow">if</span> (err!=<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00611"></a>00611         {
<a name="l00612"></a>00612             <a class="code" href="ioapi_8h.html#a715986c0415785fdc35877402429a366">ZCLOSE</a>(ziinit.<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>, ziinit.<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>);
<a name="l00613"></a>00613             <span class="keywordflow">return</span> NULL;
<a name="l00614"></a>00614         }
<a name="l00615"></a>00615 
<a name="l00616"></a>00616         <span class="keywordflow">if</span> (size_comment&gt;0)
<a name="l00617"></a>00617         {
<a name="l00618"></a>00618             ziinit.<a class="code" href="structzip__internal.html#a8a49f83da0affc89cfc541ab38e72471">globalcomment</a> = <a class="code" href="zip_8c.html#ac5c822e3692a95451e8f70a5916f05a3">ALLOC</a>(size_comment+1);
<a name="l00619"></a>00619             <span class="keywordflow">if</span> (ziinit.<a class="code" href="structzip__internal.html#a8a49f83da0affc89cfc541ab38e72471">globalcomment</a>)
<a name="l00620"></a>00620             {
<a name="l00621"></a>00621                size_comment = <a class="code" href="ioapi_8h.html#ad59236c559eb21dbdc40f86d2e97d65d">ZREAD</a>(ziinit.<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>, ziinit.<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,ziinit.<a class="code" href="structzip__internal.html#a8a49f83da0affc89cfc541ab38e72471">globalcomment</a>,size_comment);
<a name="l00622"></a>00622                ziinit.<a class="code" href="structzip__internal.html#a8a49f83da0affc89cfc541ab38e72471">globalcomment</a>[size_comment]=0;
<a name="l00623"></a>00623             }
<a name="l00624"></a>00624         }
<a name="l00625"></a>00625 
<a name="l00626"></a>00626         byte_before_the_zipfile = central_pos -
<a name="l00627"></a>00627                                 (offset_central_dir+size_central_dir);
<a name="l00628"></a>00628         ziinit.<a class="code" href="structzip__internal.html#a6cd048a07f19de1144c9a7edc3645422">add_position_when_writting_offset</a> = byte_before_the_zipfile;
<a name="l00629"></a>00629 
<a name="l00630"></a>00630         {
<a name="l00631"></a>00631             <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> size_central_dir_to_read = size_central_dir;
<a name="l00632"></a>00632             <span class="keywordtype">size_t</span> buf_size = SIZEDATA_INDATABLOCK;
<a name="l00633"></a>00633             <span class="keywordtype">void</span>* buf_read = (<span class="keywordtype">void</span>*)<a class="code" href="zip_8c.html#ac5c822e3692a95451e8f70a5916f05a3">ALLOC</a>(buf_size);
<a name="l00634"></a>00634             <span class="keywordflow">if</span> (<a class="code" href="ioapi_8h.html#a150463ba2515263515f68599c580b64e">ZSEEK</a>(ziinit.<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>, ziinit.<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,
<a name="l00635"></a>00635                   offset_central_dir + byte_before_the_zipfile,
<a name="l00636"></a>00636                   <a class="code" href="ioapi_8h.html#a962e25bd3652f31479b855be08836c16">ZLIB_FILEFUNC_SEEK_SET</a>) != 0)
<a name="l00637"></a>00637                   err=<a class="code" href="zip_8h.html#a94d5d490eddae7316ed282729fdc4bf2">ZIP_ERRNO</a>;
<a name="l00638"></a>00638 
<a name="l00639"></a>00639             <span class="keywordflow">while</span> ((size_central_dir_to_read&gt;0) &amp;&amp; (err==ZIP_OK))
<a name="l00640"></a>00640             {
<a name="l00641"></a>00641                 <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> read_this = SIZEDATA_INDATABLOCK;
<a name="l00642"></a>00642                 <span class="keywordflow">if</span> (read_this &gt; size_central_dir_to_read)
<a name="l00643"></a>00643                     read_this = size_central_dir_to_read;
<a name="l00644"></a>00644                 <span class="keywordflow">if</span> (<a class="code" href="ioapi_8h.html#ad59236c559eb21dbdc40f86d2e97d65d">ZREAD</a>(ziinit.<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>, ziinit.<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,buf_read,read_this) != read_this)
<a name="l00645"></a>00645                     err=<a class="code" href="zip_8h.html#a94d5d490eddae7316ed282729fdc4bf2">ZIP_ERRNO</a>;
<a name="l00646"></a>00646 
<a name="l00647"></a>00647                 <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00648"></a>00648                     err = <a class="code" href="zip_8c.html#af411f447b40db1fad258dee3b786ccc1">add_data_in_datablock</a>(&amp;ziinit.<a class="code" href="structzip__internal.html#ae63acf37b5a3719b3eae7802115ed73c">central_dir</a>,buf_read,
<a name="l00649"></a>00649                                                 (<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)read_this);
<a name="l00650"></a>00650                 size_central_dir_to_read-=read_this;
<a name="l00651"></a>00651             }
<a name="l00652"></a>00652             <a class="code" href="zip_8c.html#a5fb23c00a00f3856832e660edc2ab03d">TRYFREE</a>(buf_read);
<a name="l00653"></a>00653         }
<a name="l00654"></a>00654         ziinit.<a class="code" href="structzip__internal.html#a913be8e62247a3fbe1ffcdf7c03d0248">begin_pos</a> = byte_before_the_zipfile;
<a name="l00655"></a>00655         ziinit.<a class="code" href="structzip__internal.html#a8415937c4a5b2afc0adde407d59f2750">number_entry</a> = number_entry_CD;
<a name="l00656"></a>00656 
<a name="l00657"></a>00657         <span class="keywordflow">if</span> (<a class="code" href="ioapi_8h.html#a150463ba2515263515f68599c580b64e">ZSEEK</a>(ziinit.<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>, ziinit.<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,
<a name="l00658"></a>00658                   offset_central_dir+byte_before_the_zipfile,<a class="code" href="ioapi_8h.html#a962e25bd3652f31479b855be08836c16">ZLIB_FILEFUNC_SEEK_SET</a>)!=0)
<a name="l00659"></a>00659             err=ZIP_ERRNO;
<a name="l00660"></a>00660     }
<a name="l00661"></a>00661 
<a name="l00662"></a>00662     <span class="keywordflow">if</span> (globalcomment)
<a name="l00663"></a>00663     {
<a name="l00664"></a>00664       *globalcomment = ziinit.<a class="code" href="structzip__internal.html#a8a49f83da0affc89cfc541ab38e72471">globalcomment</a>;
<a name="l00665"></a>00665     }
<a name="l00666"></a>00666 <span class="preprocessor">#    endif </span><span class="comment">/* !NO_ADDFILEINEXISTINGZIP*/</span>
<a name="l00667"></a>00667 
<a name="l00668"></a>00668     <span class="keywordflow">if</span> (err != <a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00669"></a>00669     {
<a name="l00670"></a>00670 <span class="preprocessor">#    ifndef NO_ADDFILEINEXISTINGZIP</span>
<a name="l00671"></a>00671 <span class="preprocessor"></span>        <a class="code" href="zip_8c.html#a5fb23c00a00f3856832e660edc2ab03d">TRYFREE</a>(ziinit.<a class="code" href="structzip__internal.html#a8a49f83da0affc89cfc541ab38e72471">globalcomment</a>);
<a name="l00672"></a>00672 <span class="preprocessor">#    endif </span><span class="comment">/* !NO_ADDFILEINEXISTINGZIP*/</span>
<a name="l00673"></a>00673         <a class="code" href="zip_8c.html#a5fb23c00a00f3856832e660edc2ab03d">TRYFREE</a>(zi);
<a name="l00674"></a>00674         <span class="keywordflow">return</span> NULL;
<a name="l00675"></a>00675     }
<a name="l00676"></a>00676     <span class="keywordflow">else</span>
<a name="l00677"></a>00677     {
<a name="l00678"></a>00678         *zi = ziinit;
<a name="l00679"></a>00679         <span class="keywordflow">return</span> (<a class="code" href="zip_8h.html#af69b9a5ea9aaf8e8f0b7681e451b224c">zipFile</a>)zi;
<a name="l00680"></a>00680     }
<a name="l00681"></a>00681 }
<a name="l00682"></a>00682 
<a name="l00683"></a><a class="code" href="zip_8c.html#a0fdf7997a92da1a0e3e0ec4fc270494c">00683</a> <span class="keyword">extern</span> <a class="code" href="zip_8h.html#af69b9a5ea9aaf8e8f0b7681e451b224c">zipFile</a> ZEXPORT <a class="code" href="zip_8c.html#a0fdf7997a92da1a0e3e0ec4fc270494c">zipOpen</a> (pathname, append)
<a name="l00684"></a>00684     const <span class="keywordtype">char</span> *pathname;
<a name="l00685"></a>00685     <span class="keywordtype">int</span> append;
<a name="l00686"></a>00686 {
<a name="l00687"></a>00687     <span class="keywordflow">return</span> <a class="code" href="zip_8c.html#a1e81b9e717c86e8c7ef8914534cd83e1">zipOpen2</a>(pathname,append,NULL,NULL);
<a name="l00688"></a>00688 }
<a name="l00689"></a>00689 
<a name="l00690"></a><a class="code" href="zip_8c.html#a6b17cc2fa173054a156218befe2b31f5">00690</a> <span class="keyword">extern</span> <span class="keywordtype">int</span> ZEXPORT <a class="code" href="zip_8c.html#a6b17cc2fa173054a156218befe2b31f5">zipOpenNewFileInZip3</a> (file, <a class="code" href="ioapi_8h.html#a7a03a664b090ce5c848ecb31cb4a2fa8">filename</a>, zipfi,
<a name="l00691"></a>00691                                          extrafield_local, size_extrafield_local,
<a name="l00692"></a>00692                                          extrafield_global, size_extrafield_global,
<a name="l00693"></a>00693                                          comment, method, level, raw,
<a name="l00694"></a>00694                                          windowBits, memLevel, strategy,
<a name="l00695"></a>00695                                          password, crcForCrypting)
<a name="l00696"></a>00696     <a class="code" href="zip_8h.html#af69b9a5ea9aaf8e8f0b7681e451b224c">zipFile</a> file;
<a name="l00697"></a>00697     const <span class="keywordtype">char</span>* <a class="code" href="ioapi_8h.html#a7a03a664b090ce5c848ecb31cb4a2fa8">filename</a>;
<a name="l00698"></a>00698     const <a class="code" href="structzip__fileinfo.html">zip_fileinfo</a>* zipfi;
<a name="l00699"></a>00699     const <span class="keywordtype">void</span>* extrafield_local;
<a name="l00700"></a>00700     uInt size_extrafield_local;
<a name="l00701"></a>00701     const <span class="keywordtype">void</span>* extrafield_global;
<a name="l00702"></a>00702     uInt size_extrafield_global;
<a name="l00703"></a>00703     const <span class="keywordtype">char</span>* comment;
<a name="l00704"></a>00704     <span class="keywordtype">int</span> method;
<a name="l00705"></a>00705     <span class="keywordtype">int</span> level;
<a name="l00706"></a>00706     <span class="keywordtype">int</span> raw;
<a name="l00707"></a>00707     <span class="keywordtype">int</span> windowBits;
<a name="l00708"></a>00708     <span class="keywordtype">int</span> memLevel;
<a name="l00709"></a>00709     <span class="keywordtype">int</span> strategy;
<a name="l00710"></a>00710     const <span class="keywordtype">char</span>* password;
<a name="l00711"></a>00711     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> crcForCrypting;
<a name="l00712"></a>00712 {
<a name="l00713"></a>00713     <a class="code" href="structzip__internal.html">zip_internal</a>* zi;
<a name="l00714"></a>00714     uInt size_filename;
<a name="l00715"></a>00715     uInt size_comment;
<a name="l00716"></a>00716     uInt i;
<a name="l00717"></a>00717     <span class="keywordtype">int</span> err = ZIP_OK;
<a name="l00718"></a>00718 
<a name="l00719"></a>00719 <span class="preprocessor">#    ifdef NOCRYPT</span>
<a name="l00720"></a>00720 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (password != NULL)
<a name="l00721"></a>00721         <span class="keywordflow">return</span> ZIP_PARAMERROR;
<a name="l00722"></a>00722 <span class="preprocessor">#    endif</span>
<a name="l00723"></a>00723 <span class="preprocessor"></span>
<a name="l00724"></a>00724     <span class="keywordflow">if</span> (file == NULL)
<a name="l00725"></a>00725         <span class="keywordflow">return</span> ZIP_PARAMERROR;
<a name="l00726"></a>00726     <span class="keywordflow">if</span> ((method!=0) &amp;&amp; (method!=Z_DEFLATED))
<a name="l00727"></a>00727         <span class="keywordflow">return</span> ZIP_PARAMERROR;
<a name="l00728"></a>00728 
<a name="l00729"></a>00729     zi = (<a class="code" href="structzip__internal.html">zip_internal</a>*)file;
<a name="l00730"></a>00730 
<a name="l00731"></a>00731     <span class="keywordflow">if</span> (zi-&gt;<a class="code" href="structzip__internal.html#a98dbf3927482a45adefcd32d12bd7840">in_opened_file_inzip</a> == 1)
<a name="l00732"></a>00732     {
<a name="l00733"></a>00733         err = <a class="code" href="zip_8c.html#ae470f753aef4cffe4f77a5ec2bcfbde1">zipCloseFileInZip</a> (file);
<a name="l00734"></a>00734         <span class="keywordflow">if</span> (err != <a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00735"></a>00735             <span class="keywordflow">return</span> err;
<a name="l00736"></a>00736     }
<a name="l00737"></a>00737 
<a name="l00738"></a>00738 
<a name="l00739"></a>00739     <span class="keywordflow">if</span> (filename==NULL)
<a name="l00740"></a>00740         filename=<span class="stringliteral">&quot;-&quot;</span>;
<a name="l00741"></a>00741 
<a name="l00742"></a>00742     <span class="keywordflow">if</span> (comment==NULL)
<a name="l00743"></a>00743         size_comment = 0;
<a name="l00744"></a>00744     <span class="keywordflow">else</span>
<a name="l00745"></a>00745         size_comment = (uInt)strlen(comment);
<a name="l00746"></a>00746 
<a name="l00747"></a>00747     size_filename = (uInt)strlen(filename);
<a name="l00748"></a>00748 
<a name="l00749"></a>00749     <span class="keywordflow">if</span> (zipfi == NULL)
<a name="l00750"></a>00750         zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#afb63cc461b5237c76e41904ed9fb726a">dosDate</a> = 0;
<a name="l00751"></a>00751     <span class="keywordflow">else</span>
<a name="l00752"></a>00752     {
<a name="l00753"></a>00753         <span class="keywordflow">if</span> (zipfi-&gt;<a class="code" href="structzip__fileinfo.html#a0541c57e59450fbc17b2f898ca4bc9e8">dosDate</a> != 0)
<a name="l00754"></a>00754             zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#afb63cc461b5237c76e41904ed9fb726a">dosDate</a> = zipfi-&gt;<a class="code" href="structzip__fileinfo.html#a0541c57e59450fbc17b2f898ca4bc9e8">dosDate</a>;
<a name="l00755"></a>00755         <span class="keywordflow">else</span> zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#afb63cc461b5237c76e41904ed9fb726a">dosDate</a> = <a class="code" href="zip_8c.html#ade96cb6f6a8e958347d2416c6825296c">ziplocal_TmzDateToDosDate</a>(&amp;zipfi-&gt;<a class="code" href="structzip__fileinfo.html#ae09a694a598b7507d23705764c9e46fb">tmz_date</a>,zipfi-&gt;<a class="code" href="structzip__fileinfo.html#a0541c57e59450fbc17b2f898ca4bc9e8">dosDate</a>);
<a name="l00756"></a>00756     }
<a name="l00757"></a>00757 
<a name="l00758"></a>00758     zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a9484e7dcce78fd7856e3048357115172">flag</a> = 0;
<a name="l00759"></a>00759     <span class="keywordflow">if</span> ((level==8) || (level==9))
<a name="l00760"></a>00760       zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a9484e7dcce78fd7856e3048357115172">flag</a> |= 2;
<a name="l00761"></a>00761     <span class="keywordflow">if</span> ((level==2))
<a name="l00762"></a>00762       zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a9484e7dcce78fd7856e3048357115172">flag</a> |= 4;
<a name="l00763"></a>00763     <span class="keywordflow">if</span> ((level==1))
<a name="l00764"></a>00764       zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a9484e7dcce78fd7856e3048357115172">flag</a> |= 6;
<a name="l00765"></a>00765     <span class="keywordflow">if</span> (password != NULL)
<a name="l00766"></a>00766       zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a9484e7dcce78fd7856e3048357115172">flag</a> |= 1;
<a name="l00767"></a>00767 
<a name="l00768"></a>00768     zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ab58f6860a40fdaf0932d659d8743f876">crc32</a> = 0;
<a name="l00769"></a>00769     zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ac69364c19c39e2962e8f247f4b760d5f">method</a> = method;
<a name="l00770"></a>00770     zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a5bc94d3a94e6ffe7f4e4783c668a263e">encrypt</a> = 0;
<a name="l00771"></a>00771     zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a4408645945defb3e3e72fd354d4e98b2">stream_initialised</a> = 0;
<a name="l00772"></a>00772     zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ab1e433122ecceb389c8d258830e89f6f">pos_in_buffered_data</a> = 0;
<a name="l00773"></a>00773     zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ab79a678fff8d4fb6e55f410d33a5d555">raw</a> = raw;
<a name="l00774"></a>00774     zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ae859aac5711395f5136a26a393f4f3ec">pos_local_header</a> = <a class="code" href="ioapi_8h.html#a6010b5be81cd016bf0fe649cea4cf2c2">ZTELL</a>(zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>) ;
<a name="l00775"></a>00775     zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a25272deebbc7e9f5f474f4c2b36e27a6">size_centralheader</a> = <a class="code" href="zip_8c.html#a1d462da8349d0e3e53ecbaf284336066">SIZECENTRALHEADER</a> + size_filename +
<a name="l00776"></a>00776                                       size_extrafield_global + size_comment;
<a name="l00777"></a>00777     zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a> = (<span class="keywordtype">char</span>*)<a class="code" href="zip_8c.html#ac5c822e3692a95451e8f70a5916f05a3">ALLOC</a>((uInt)zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a25272deebbc7e9f5f474f4c2b36e27a6">size_centralheader</a>);
<a name="l00778"></a>00778 
<a name="l00779"></a>00779     <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)<a class="code" href="zip_8c.html#a693b6919a7002d5d8f2030ea38bdb745">CENTRALHEADERMAGIC</a>,4);
<a name="l00780"></a>00780     <span class="comment">/* version info */</span>
<a name="l00781"></a>00781     <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+4,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)<a class="code" href="zip_8c.html#a0887c08f255f7a753b460e30ed14a3cf">VERSIONMADEBY</a>,2);
<a name="l00782"></a>00782     <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+6,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)20,2);
<a name="l00783"></a>00783     <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+8,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a9484e7dcce78fd7856e3048357115172">flag</a>,2);
<a name="l00784"></a>00784     <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+10,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ac69364c19c39e2962e8f247f4b760d5f">method</a>,2);
<a name="l00785"></a>00785     <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+12,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#afb63cc461b5237c76e41904ed9fb726a">dosDate</a>,4);
<a name="l00786"></a>00786     <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+16,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)0,4); <span class="comment">/*crc*/</span>
<a name="l00787"></a>00787     <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+20,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)0,4); <span class="comment">/*compr size*/</span>
<a name="l00788"></a>00788     <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+24,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)0,4); <span class="comment">/*uncompr size*/</span>
<a name="l00789"></a>00789     <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+28,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)size_filename,2);
<a name="l00790"></a>00790     <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+30,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)size_extrafield_global,2);
<a name="l00791"></a>00791     <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+32,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)size_comment,2);
<a name="l00792"></a>00792     <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+34,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)0,2); <span class="comment">/*disk nm start*/</span>
<a name="l00793"></a>00793 
<a name="l00794"></a>00794     <span class="keywordflow">if</span> (zipfi==NULL)
<a name="l00795"></a>00795         <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+36,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)0,2);
<a name="l00796"></a>00796     <span class="keywordflow">else</span>
<a name="l00797"></a>00797         <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+36,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)zipfi-&gt;<a class="code" href="structzip__fileinfo.html#a396175a434b86115ce5600ab1dbb1644">internal_fa</a>,2);
<a name="l00798"></a>00798 
<a name="l00799"></a>00799     <span class="keywordflow">if</span> (zipfi==NULL)
<a name="l00800"></a>00800         <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+38,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)0,4);
<a name="l00801"></a>00801     <span class="keywordflow">else</span>
<a name="l00802"></a>00802         <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+38,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)zipfi-&gt;<a class="code" href="structzip__fileinfo.html#ac0be78ded330ffd46815bafc5b6b37bb">external_fa</a>,4);
<a name="l00803"></a>00803 
<a name="l00804"></a>00804     <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+42,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ae859aac5711395f5136a26a393f4f3ec">pos_local_header</a>- zi-&gt;<a class="code" href="structzip__internal.html#a6cd048a07f19de1144c9a7edc3645422">add_position_when_writting_offset</a>,4);
<a name="l00805"></a>00805 
<a name="l00806"></a>00806     <span class="keywordflow">for</span> (i=0;i&lt;size_filename;i++)
<a name="l00807"></a>00807         *(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+<a class="code" href="zip_8c.html#a1d462da8349d0e3e53ecbaf284336066">SIZECENTRALHEADER</a>+i) = *(filename+i);
<a name="l00808"></a>00808 
<a name="l00809"></a>00809     <span class="keywordflow">for</span> (i=0;i&lt;size_extrafield_global;i++)
<a name="l00810"></a>00810         *(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+<a class="code" href="zip_8c.html#a1d462da8349d0e3e53ecbaf284336066">SIZECENTRALHEADER</a>+size_filename+i) =
<a name="l00811"></a>00811               *(((<span class="keyword">const</span> <span class="keywordtype">char</span>*)extrafield_global)+i);
<a name="l00812"></a>00812 
<a name="l00813"></a>00813     <span class="keywordflow">for</span> (i=0;i&lt;size_comment;i++)
<a name="l00814"></a>00814         *(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+<a class="code" href="zip_8c.html#a1d462da8349d0e3e53ecbaf284336066">SIZECENTRALHEADER</a>+size_filename+
<a name="l00815"></a>00815               size_extrafield_global+i) = *(comment+i);
<a name="l00816"></a>00816     <span class="keywordflow">if</span> (zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a> == NULL)
<a name="l00817"></a>00817         <span class="keywordflow">return</span> ZIP_INTERNALERROR;
<a name="l00818"></a>00818 
<a name="l00819"></a>00819     <span class="comment">/* write the local header */</span>
<a name="l00820"></a>00820     err = <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)<a class="code" href="zip_8c.html#a9341868e4dbaa2610fe54b599cd8965f">LOCALHEADERMAGIC</a>,4);
<a name="l00821"></a>00821 
<a name="l00822"></a>00822     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00823"></a>00823         err = <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)20,2);<span class="comment">/* version needed to extract */</span>
<a name="l00824"></a>00824     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00825"></a>00825         err = <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a9484e7dcce78fd7856e3048357115172">flag</a>,2);
<a name="l00826"></a>00826 
<a name="l00827"></a>00827     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00828"></a>00828         err = <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ac69364c19c39e2962e8f247f4b760d5f">method</a>,2);
<a name="l00829"></a>00829 
<a name="l00830"></a>00830     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00831"></a>00831         err = <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#afb63cc461b5237c76e41904ed9fb726a">dosDate</a>,4);
<a name="l00832"></a>00832 
<a name="l00833"></a>00833     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00834"></a>00834         err = <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)0,4); <span class="comment">/* crc 32, unknown */</span>
<a name="l00835"></a>00835     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00836"></a>00836         err = <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)0,4); <span class="comment">/* compressed size, unknown */</span>
<a name="l00837"></a>00837     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00838"></a>00838         err = <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)0,4); <span class="comment">/* uncompressed size, unknown */</span>
<a name="l00839"></a>00839 
<a name="l00840"></a>00840     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00841"></a>00841         err = <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)size_filename,2);
<a name="l00842"></a>00842 
<a name="l00843"></a>00843     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00844"></a>00844         err = <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)size_extrafield_local,2);
<a name="l00845"></a>00845 
<a name="l00846"></a>00846     <span class="keywordflow">if</span> ((err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>) &amp;&amp; (size_filename&gt;0))
<a name="l00847"></a>00847         <span class="keywordflow">if</span> (<a class="code" href="ioapi_8h.html#a440d7e7546b628b36ae22ab621d43d8c">ZWRITE</a>(zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,filename,size_filename)!=size_filename)
<a name="l00848"></a>00848                 err = ZIP_ERRNO;
<a name="l00849"></a>00849 
<a name="l00850"></a>00850     <span class="keywordflow">if</span> ((err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>) &amp;&amp; (size_extrafield_local&gt;0))
<a name="l00851"></a>00851         <span class="keywordflow">if</span> (<a class="code" href="ioapi_8h.html#a440d7e7546b628b36ae22ab621d43d8c">ZWRITE</a>(zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,extrafield_local,size_extrafield_local)
<a name="l00852"></a>00852                                                                            !=size_extrafield_local)
<a name="l00853"></a>00853                 err = ZIP_ERRNO;
<a name="l00854"></a>00854 
<a name="l00855"></a>00855     zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.avail_in = (uInt)0;
<a name="l00856"></a>00856     zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.avail_out = (uInt)<a class="code" href="zip_8c.html#a1491823e6cf52e751120f367bdc68a00">Z_BUFSIZE</a>;
<a name="l00857"></a>00857     zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.next_out = zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a73ba705398941ee5d8f0cfc61df6b82d">buffered_data</a>;
<a name="l00858"></a>00858     zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.total_in = 0;
<a name="l00859"></a>00859     zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.total_out = 0;
<a name="l00860"></a>00860 
<a name="l00861"></a>00861     <span class="keywordflow">if</span> ((err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>) &amp;&amp; (zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ac69364c19c39e2962e8f247f4b760d5f">method</a> == Z_DEFLATED) &amp;&amp; (!zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ab79a678fff8d4fb6e55f410d33a5d555">raw</a>))
<a name="l00862"></a>00862     {
<a name="l00863"></a>00863         zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.zalloc = (alloc_func)0;
<a name="l00864"></a>00864         zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.zfree = (free_func)0;
<a name="l00865"></a>00865         zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.opaque = (voidpf)0;
<a name="l00866"></a>00866 
<a name="l00867"></a>00867         <span class="keywordflow">if</span> (windowBits&gt;0)
<a name="l00868"></a>00868             windowBits = -windowBits;
<a name="l00869"></a>00869 
<a name="l00870"></a>00870         err = deflateInit2(&amp;zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>, level,
<a name="l00871"></a>00871                Z_DEFLATED, windowBits, memLevel, strategy);
<a name="l00872"></a>00872 
<a name="l00873"></a>00873         <span class="keywordflow">if</span> (err==Z_OK)
<a name="l00874"></a>00874             zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a4408645945defb3e3e72fd354d4e98b2">stream_initialised</a> = 1;
<a name="l00875"></a>00875     }
<a name="l00876"></a>00876 <span class="preprocessor">#    ifndef NOCRYPT</span>
<a name="l00877"></a>00877 <span class="preprocessor"></span>    zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#aec9ef70b3fa0459612a2c2b5c8c2c4ea">crypt_header_size</a> = 0;
<a name="l00878"></a>00878     <span class="keywordflow">if</span> ((err==Z_OK) &amp;&amp; (password != NULL))
<a name="l00879"></a>00879     {
<a name="l00880"></a>00880         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> bufHead[RAND_HEAD_LEN];
<a name="l00881"></a>00881         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sizeHead;
<a name="l00882"></a>00882         zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a5bc94d3a94e6ffe7f4e4783c668a263e">encrypt</a> = 1;
<a name="l00883"></a>00883         zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a9de6dd632a0a1eaad2729ae1f993fa71">pcrc_32_tab</a> = get_crc_table();
<a name="l00884"></a>00884         <span class="comment">/*init_keys(password,zi-&gt;ci.keys,zi-&gt;ci.pcrc_32_tab);*/</span>
<a name="l00885"></a>00885 
<a name="l00886"></a>00886         sizeHead=crypthead(password,bufHead,RAND_HEAD_LEN,zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ac6836b3fb49829e3490cae1e8e319ed6">keys</a>,zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a9de6dd632a0a1eaad2729ae1f993fa71">pcrc_32_tab</a>,crcForCrypting);
<a name="l00887"></a>00887         zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#aec9ef70b3fa0459612a2c2b5c8c2c4ea">crypt_header_size</a> = sizeHead;
<a name="l00888"></a>00888 
<a name="l00889"></a>00889         <span class="keywordflow">if</span> (<a class="code" href="ioapi_8h.html#a440d7e7546b628b36ae22ab621d43d8c">ZWRITE</a>(zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,bufHead,sizeHead) != sizeHead)
<a name="l00890"></a>00890                 err = ZIP_ERRNO;
<a name="l00891"></a>00891     }
<a name="l00892"></a>00892 <span class="preprocessor">#    endif</span>
<a name="l00893"></a>00893 <span class="preprocessor"></span>
<a name="l00894"></a>00894     <span class="keywordflow">if</span> (err==Z_OK)
<a name="l00895"></a>00895         zi-&gt;<a class="code" href="structzip__internal.html#a98dbf3927482a45adefcd32d12bd7840">in_opened_file_inzip</a> = 1;
<a name="l00896"></a>00896     <span class="keywordflow">return</span> err;
<a name="l00897"></a>00897 }
<a name="l00898"></a>00898 
<a name="l00899"></a><a class="code" href="zip_8c.html#ae3c822f7ddf7c351e7a6c633ed1590d4">00899</a> <span class="keyword">extern</span> <span class="keywordtype">int</span> ZEXPORT <a class="code" href="zip_8c.html#ae3c822f7ddf7c351e7a6c633ed1590d4">zipOpenNewFileInZip2</a>(file, <a class="code" href="ioapi_8h.html#a7a03a664b090ce5c848ecb31cb4a2fa8">filename</a>, zipfi,
<a name="l00900"></a>00900                                         extrafield_local, size_extrafield_local,
<a name="l00901"></a>00901                                         extrafield_global, size_extrafield_global,
<a name="l00902"></a>00902                                         comment, method, level, raw)
<a name="l00903"></a>00903     <a class="code" href="zip_8h.html#af69b9a5ea9aaf8e8f0b7681e451b224c">zipFile</a> file;
<a name="l00904"></a>00904     const <span class="keywordtype">char</span>* <a class="code" href="ioapi_8h.html#a7a03a664b090ce5c848ecb31cb4a2fa8">filename</a>;
<a name="l00905"></a>00905     const <a class="code" href="structzip__fileinfo.html">zip_fileinfo</a>* zipfi;
<a name="l00906"></a>00906     const <span class="keywordtype">void</span>* extrafield_local;
<a name="l00907"></a>00907     uInt size_extrafield_local;
<a name="l00908"></a>00908     const <span class="keywordtype">void</span>* extrafield_global;
<a name="l00909"></a>00909     uInt size_extrafield_global;
<a name="l00910"></a>00910     const <span class="keywordtype">char</span>* comment;
<a name="l00911"></a>00911     <span class="keywordtype">int</span> method;
<a name="l00912"></a>00912     <span class="keywordtype">int</span> level;
<a name="l00913"></a>00913     <span class="keywordtype">int</span> raw;
<a name="l00914"></a>00914 {
<a name="l00915"></a>00915     <span class="keywordflow">return</span> <a class="code" href="zip_8c.html#a6b17cc2fa173054a156218befe2b31f5">zipOpenNewFileInZip3</a> (file, filename, zipfi,
<a name="l00916"></a>00916                                  extrafield_local, size_extrafield_local,
<a name="l00917"></a>00917                                  extrafield_global, size_extrafield_global,
<a name="l00918"></a>00918                                  comment, method, level, raw,
<a name="l00919"></a>00919                                  -MAX_WBITS, <a class="code" href="zip_8h.html#a19c8e60fa32d4ddf303ce988ba97af61">DEF_MEM_LEVEL</a>, Z_DEFAULT_STRATEGY,
<a name="l00920"></a>00920                                  NULL, 0);
<a name="l00921"></a>00921 }
<a name="l00922"></a>00922 
<a name="l00923"></a><a class="code" href="zip_8c.html#a14cf664b19f00f41f6865a7c3173e973">00923</a> <span class="keyword">extern</span> <span class="keywordtype">int</span> ZEXPORT <a class="code" href="zip_8c.html#a14cf664b19f00f41f6865a7c3173e973">zipOpenNewFileInZip</a> (file, <a class="code" href="ioapi_8h.html#a7a03a664b090ce5c848ecb31cb4a2fa8">filename</a>, zipfi,
<a name="l00924"></a>00924                                         extrafield_local, size_extrafield_local,
<a name="l00925"></a>00925                                         extrafield_global, size_extrafield_global,
<a name="l00926"></a>00926                                         comment, method, level)
<a name="l00927"></a>00927     <a class="code" href="zip_8h.html#af69b9a5ea9aaf8e8f0b7681e451b224c">zipFile</a> file;
<a name="l00928"></a>00928     const <span class="keywordtype">char</span>* <a class="code" href="ioapi_8h.html#a7a03a664b090ce5c848ecb31cb4a2fa8">filename</a>;
<a name="l00929"></a>00929     const <a class="code" href="structzip__fileinfo.html">zip_fileinfo</a>* zipfi;
<a name="l00930"></a>00930     const <span class="keywordtype">void</span>* extrafield_local;
<a name="l00931"></a>00931     uInt size_extrafield_local;
<a name="l00932"></a>00932     const <span class="keywordtype">void</span>* extrafield_global;
<a name="l00933"></a>00933     uInt size_extrafield_global;
<a name="l00934"></a>00934     const <span class="keywordtype">char</span>* comment;
<a name="l00935"></a>00935     <span class="keywordtype">int</span> method;
<a name="l00936"></a>00936     <span class="keywordtype">int</span> level;
<a name="l00937"></a>00937 {
<a name="l00938"></a>00938     <span class="keywordflow">return</span> <a class="code" href="zip_8c.html#ae3c822f7ddf7c351e7a6c633ed1590d4">zipOpenNewFileInZip2</a> (file, filename, zipfi,
<a name="l00939"></a>00939                                  extrafield_local, size_extrafield_local,
<a name="l00940"></a>00940                                  extrafield_global, size_extrafield_global,
<a name="l00941"></a>00941                                  comment, method, level, 0);
<a name="l00942"></a>00942 }
<a name="l00943"></a>00943 
<a name="l00944"></a><a class="code" href="zip_8c.html#aadb3c186982cb10b9e1fd03953752abd">00944</a> <a class="code" href="zip_8c.html#a08023ea6765c99d60a6a3840cd07156e">local</a> <span class="keywordtype">int</span> <a class="code" href="zip_8c.html#aadb3c186982cb10b9e1fd03953752abd">zipFlushWriteBuffer</a>(zi)
<a name="l00945"></a>00945   <a class="code" href="structzip__internal.html">zip_internal</a>* zi;
<a name="l00946"></a>00946 {
<a name="l00947"></a>00947     <span class="keywordtype">int</span> err=ZIP_OK;
<a name="l00948"></a>00948 
<a name="l00949"></a>00949     <span class="keywordflow">if</span> (zi-&gt;ci.encrypt != 0)
<a name="l00950"></a>00950     {
<a name="l00951"></a>00951 <span class="preprocessor">#ifndef NOCRYPT</span>
<a name="l00952"></a>00952 <span class="preprocessor"></span>        uInt i;
<a name="l00953"></a>00953         <span class="keywordtype">int</span> t;
<a name="l00954"></a>00954         <span class="keywordflow">for</span> (i=0;i&lt;zi-&gt;ci.pos_in_buffered_data;i++)
<a name="l00955"></a>00955             zi-&gt;ci.buffered_data[i] = <a class="code" href="crypt_8h.html#ab9d6a91abe3a1127f8b5476ba9ee9316">zencode</a>(zi-&gt;ci.keys, zi-&gt;ci.pcrc_32_tab,
<a name="l00956"></a>00956                                        zi-&gt;ci.buffered_data[i],t);
<a name="l00957"></a>00957 <span class="preprocessor">#endif</span>
<a name="l00958"></a>00958 <span class="preprocessor"></span>    }
<a name="l00959"></a>00959     <span class="keywordflow">if</span> (<a class="code" href="ioapi_8h.html#a440d7e7546b628b36ae22ab621d43d8c">ZWRITE</a>(zi-&gt;z_filefunc,zi-&gt;filestream,zi-&gt;ci.buffered_data,zi-&gt;ci.pos_in_buffered_data)
<a name="l00960"></a>00960                                                                     !=zi-&gt;ci.pos_in_buffered_data)
<a name="l00961"></a>00961       err = ZIP_ERRNO;
<a name="l00962"></a>00962     zi-&gt;ci.pos_in_buffered_data = 0;
<a name="l00963"></a>00963     <span class="keywordflow">return</span> err;
<a name="l00964"></a>00964 }
<a name="l00965"></a>00965 
<a name="l00966"></a><a class="code" href="zip_8c.html#aaffa2f0481089a2d4ddcef60132687ae">00966</a> <span class="keyword">extern</span> <span class="keywordtype">int</span> ZEXPORT <a class="code" href="zip_8c.html#aaffa2f0481089a2d4ddcef60132687ae">zipWriteInFileInZip</a> (file, <a class="code" href="ioapi_8h.html#a8ad8a13c88886b9f623034ff88570adb">buf</a>, len)
<a name="l00967"></a>00967     <a class="code" href="zip_8h.html#af69b9a5ea9aaf8e8f0b7681e451b224c">zipFile</a> file;
<a name="l00968"></a>00968     const <span class="keywordtype">void</span>* <a class="code" href="ioapi_8h.html#a8ad8a13c88886b9f623034ff88570adb">buf</a>;
<a name="l00969"></a>00969     <span class="keywordtype">unsigned</span> len;
<a name="l00970"></a>00970 {
<a name="l00971"></a>00971     <a class="code" href="structzip__internal.html">zip_internal</a>* zi;
<a name="l00972"></a>00972     <span class="keywordtype">int</span> err=ZIP_OK;
<a name="l00973"></a>00973 
<a name="l00974"></a>00974     <span class="keywordflow">if</span> (file == NULL)
<a name="l00975"></a>00975         <span class="keywordflow">return</span> ZIP_PARAMERROR;
<a name="l00976"></a>00976     zi = (<a class="code" href="structzip__internal.html">zip_internal</a>*)file;
<a name="l00977"></a>00977 
<a name="l00978"></a>00978     <span class="keywordflow">if</span> (zi-&gt;<a class="code" href="structzip__internal.html#a98dbf3927482a45adefcd32d12bd7840">in_opened_file_inzip</a> == 0)
<a name="l00979"></a>00979         <span class="keywordflow">return</span> ZIP_PARAMERROR;
<a name="l00980"></a>00980 
<a name="l00981"></a>00981     zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.next_in = (<span class="keywordtype">void</span>*)buf;
<a name="l00982"></a>00982     zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.avail_in = len;
<a name="l00983"></a>00983     zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ab58f6860a40fdaf0932d659d8743f876">crc32</a> = crc32(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ab58f6860a40fdaf0932d659d8743f876">crc32</a>,buf,len);
<a name="l00984"></a>00984 
<a name="l00985"></a>00985     <span class="keywordflow">while</span> ((err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>) &amp;&amp; (zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.avail_in&gt;0))
<a name="l00986"></a>00986     {
<a name="l00987"></a>00987         <span class="keywordflow">if</span> (zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.avail_out == 0)
<a name="l00988"></a>00988         {
<a name="l00989"></a>00989             <span class="keywordflow">if</span> (<a class="code" href="zip_8c.html#aadb3c186982cb10b9e1fd03953752abd">zipFlushWriteBuffer</a>(zi) == <a class="code" href="zip_8h.html#a94d5d490eddae7316ed282729fdc4bf2">ZIP_ERRNO</a>)
<a name="l00990"></a>00990                 err = ZIP_ERRNO;
<a name="l00991"></a>00991             zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.avail_out = (uInt)<a class="code" href="zip_8c.html#a1491823e6cf52e751120f367bdc68a00">Z_BUFSIZE</a>;
<a name="l00992"></a>00992             zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.next_out = zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a73ba705398941ee5d8f0cfc61df6b82d">buffered_data</a>;
<a name="l00993"></a>00993         }
<a name="l00994"></a>00994 
<a name="l00995"></a>00995 
<a name="l00996"></a>00996         <span class="keywordflow">if</span>(err != <a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l00997"></a>00997             <span class="keywordflow">break</span>;
<a name="l00998"></a>00998 
<a name="l00999"></a>00999         <span class="keywordflow">if</span> ((zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ac69364c19c39e2962e8f247f4b760d5f">method</a> == Z_DEFLATED) &amp;&amp; (!zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ab79a678fff8d4fb6e55f410d33a5d555">raw</a>))
<a name="l01000"></a>01000         {
<a name="l01001"></a>01001             <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> uTotalOutBefore = zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.total_out;
<a name="l01002"></a>01002             err=deflate(&amp;zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>,  Z_NO_FLUSH);
<a name="l01003"></a>01003             zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ab1e433122ecceb389c8d258830e89f6f">pos_in_buffered_data</a> += (uInt)(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.total_out - uTotalOutBefore) ;
<a name="l01004"></a>01004 
<a name="l01005"></a>01005         }
<a name="l01006"></a>01006         <span class="keywordflow">else</span>
<a name="l01007"></a>01007         {
<a name="l01008"></a>01008             uInt copy_this,i;
<a name="l01009"></a>01009             <span class="keywordflow">if</span> (zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.avail_in &lt; zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.avail_out)
<a name="l01010"></a>01010                 copy_this = zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.avail_in;
<a name="l01011"></a>01011             <span class="keywordflow">else</span>
<a name="l01012"></a>01012                 copy_this = zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.avail_out;
<a name="l01013"></a>01013             <span class="keywordflow">for</span> (i=0;i&lt;copy_this;i++)
<a name="l01014"></a>01014                 *(((<span class="keywordtype">char</span>*)zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.next_out)+i) =
<a name="l01015"></a>01015                     *(((<span class="keyword">const</span> <span class="keywordtype">char</span>*)zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.next_in)+i);
<a name="l01016"></a>01016             {
<a name="l01017"></a>01017                 zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.avail_in -= copy_this;
<a name="l01018"></a>01018                 zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.avail_out-= copy_this;
<a name="l01019"></a>01019                 zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.next_in+= copy_this;
<a name="l01020"></a>01020                 zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.next_out+= copy_this;
<a name="l01021"></a>01021                 zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.total_in+= copy_this;
<a name="l01022"></a>01022                 zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.total_out+= copy_this;
<a name="l01023"></a>01023                 zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ab1e433122ecceb389c8d258830e89f6f">pos_in_buffered_data</a> += copy_this;
<a name="l01024"></a>01024             }
<a name="l01025"></a>01025         }
<a name="l01026"></a>01026     }
<a name="l01027"></a>01027 
<a name="l01028"></a>01028     <span class="keywordflow">return</span> err;
<a name="l01029"></a>01029 }
<a name="l01030"></a>01030 
<a name="l01031"></a><a class="code" href="zip_8c.html#a43fe6f36cef62c7f34c0fdb4c8288b87">01031</a> <span class="keyword">extern</span> <span class="keywordtype">int</span> ZEXPORT <a class="code" href="zip_8c.html#a43fe6f36cef62c7f34c0fdb4c8288b87">zipCloseFileInZipRaw</a> (file, uncompressed_size, crc32)
<a name="l01032"></a>01032     <a class="code" href="zip_8h.html#af69b9a5ea9aaf8e8f0b7681e451b224c">zipFile</a> file;
<a name="l01033"></a>01033     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> uncompressed_size;
<a name="l01034"></a>01034     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> crc32;
<a name="l01035"></a>01035 {
<a name="l01036"></a>01036     <a class="code" href="structzip__internal.html">zip_internal</a>* zi;
<a name="l01037"></a>01037     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> compressed_size;
<a name="l01038"></a>01038     <span class="keywordtype">int</span> err=ZIP_OK;
<a name="l01039"></a>01039 
<a name="l01040"></a>01040     <span class="keywordflow">if</span> (file == NULL)
<a name="l01041"></a>01041         <span class="keywordflow">return</span> ZIP_PARAMERROR;
<a name="l01042"></a>01042     zi = (<a class="code" href="structzip__internal.html">zip_internal</a>*)file;
<a name="l01043"></a>01043 
<a name="l01044"></a>01044     <span class="keywordflow">if</span> (zi-&gt;<a class="code" href="structzip__internal.html#a98dbf3927482a45adefcd32d12bd7840">in_opened_file_inzip</a> == 0)
<a name="l01045"></a>01045         <span class="keywordflow">return</span> ZIP_PARAMERROR;
<a name="l01046"></a>01046     zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.avail_in = 0;
<a name="l01047"></a>01047 
<a name="l01048"></a>01048     <span class="keywordflow">if</span> ((zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ac69364c19c39e2962e8f247f4b760d5f">method</a> == Z_DEFLATED) &amp;&amp; (!zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ab79a678fff8d4fb6e55f410d33a5d555">raw</a>))
<a name="l01049"></a>01049         <span class="keywordflow">while</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l01050"></a>01050     {
<a name="l01051"></a>01051         <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> uTotalOutBefore;
<a name="l01052"></a>01052         <span class="keywordflow">if</span> (zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.avail_out == 0)
<a name="l01053"></a>01053         {
<a name="l01054"></a>01054             <span class="keywordflow">if</span> (<a class="code" href="zip_8c.html#aadb3c186982cb10b9e1fd03953752abd">zipFlushWriteBuffer</a>(zi) == ZIP_ERRNO)
<a name="l01055"></a>01055                 err = <a class="code" href="zip_8h.html#a94d5d490eddae7316ed282729fdc4bf2">ZIP_ERRNO</a>;
<a name="l01056"></a>01056             zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.avail_out = (uInt)<a class="code" href="zip_8c.html#a1491823e6cf52e751120f367bdc68a00">Z_BUFSIZE</a>;
<a name="l01057"></a>01057             zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.next_out = zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a73ba705398941ee5d8f0cfc61df6b82d">buffered_data</a>;
<a name="l01058"></a>01058         }
<a name="l01059"></a>01059         uTotalOutBefore = zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.total_out;
<a name="l01060"></a>01060         err=deflate(&amp;zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>,  Z_FINISH);
<a name="l01061"></a>01061         zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ab1e433122ecceb389c8d258830e89f6f">pos_in_buffered_data</a> += (uInt)(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.total_out - uTotalOutBefore) ;
<a name="l01062"></a>01062     }
<a name="l01063"></a>01063 
<a name="l01064"></a>01064     <span class="keywordflow">if</span> (err==Z_STREAM_END)
<a name="l01065"></a>01065         err=ZIP_OK; <span class="comment">/* this is normal */</span>
<a name="l01066"></a>01066 
<a name="l01067"></a>01067     <span class="keywordflow">if</span> ((zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ab1e433122ecceb389c8d258830e89f6f">pos_in_buffered_data</a>&gt;0) &amp;&amp; (err==ZIP_OK))
<a name="l01068"></a>01068         <span class="keywordflow">if</span> (<a class="code" href="zip_8c.html#aadb3c186982cb10b9e1fd03953752abd">zipFlushWriteBuffer</a>(zi)==ZIP_ERRNO)
<a name="l01069"></a>01069             err = <a class="code" href="zip_8h.html#a94d5d490eddae7316ed282729fdc4bf2">ZIP_ERRNO</a>;
<a name="l01070"></a>01070 
<a name="l01071"></a>01071     <span class="keywordflow">if</span> ((zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ac69364c19c39e2962e8f247f4b760d5f">method</a> == Z_DEFLATED) &amp;&amp; (!zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ab79a678fff8d4fb6e55f410d33a5d555">raw</a>))
<a name="l01072"></a>01072     {
<a name="l01073"></a>01073         err=deflateEnd(&amp;zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>);
<a name="l01074"></a>01074         zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a4408645945defb3e3e72fd354d4e98b2">stream_initialised</a> = 0;
<a name="l01075"></a>01075     }
<a name="l01076"></a>01076 
<a name="l01077"></a>01077     <span class="keywordflow">if</span> (!zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ab79a678fff8d4fb6e55f410d33a5d555">raw</a>)
<a name="l01078"></a>01078     {
<a name="l01079"></a>01079         crc32 = (uLong)zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ab58f6860a40fdaf0932d659d8743f876">crc32</a>;
<a name="l01080"></a>01080         uncompressed_size = (<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.total_in;
<a name="l01081"></a>01081     }
<a name="l01082"></a>01082     compressed_size = (uLong)zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.total_out;
<a name="l01083"></a>01083 #    ifndef NOCRYPT
<a name="l01084"></a>01084     compressed_size += zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#aec9ef70b3fa0459612a2c2b5c8c2c4ea">crypt_header_size</a>;
<a name="l01085"></a>01085 #    endif
<a name="l01086"></a>01086 
<a name="l01087"></a>01087     <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+16,crc32,4); <span class="comment">/*crc*/</span>
<a name="l01088"></a>01088     <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+20,
<a name="l01089"></a>01089                                 compressed_size,4); <span class="comment">/*compr size*/</span>
<a name="l01090"></a>01090     <span class="keywordflow">if</span> (zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a902dbbcce2f8a9b5d5f0ac705f9c914c">stream</a>.data_type == Z_ASCII)
<a name="l01091"></a>01091         <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+36,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)Z_ASCII,2);
<a name="l01092"></a>01092     <a class="code" href="zip_8c.html#a9f480c0301d8b8421c4f236ddd0d96f3">ziplocal_putValue_inmemory</a>(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>+24,
<a name="l01093"></a>01093                                 uncompressed_size,4); <span class="comment">/*uncompr size*/</span>
<a name="l01094"></a>01094 
<a name="l01095"></a>01095     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l01096"></a>01096         err = <a class="code" href="zip_8c.html#af411f447b40db1fad258dee3b786ccc1">add_data_in_datablock</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#ae63acf37b5a3719b3eae7802115ed73c">central_dir</a>,zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>,
<a name="l01097"></a>01097                                        (<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a25272deebbc7e9f5f474f4c2b36e27a6">size_centralheader</a>);
<a name="l01098"></a>01098     free(zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#a6b8d86737b9297846fc67799c8c42e21">central_header</a>);
<a name="l01099"></a>01099 
<a name="l01100"></a>01100     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l01101"></a>01101     {
<a name="l01102"></a>01102         <span class="keywordtype">long</span> cur_pos_inzip = <a class="code" href="ioapi_8h.html#a6010b5be81cd016bf0fe649cea4cf2c2">ZTELL</a>(zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>);
<a name="l01103"></a>01103         <span class="keywordflow">if</span> (<a class="code" href="ioapi_8h.html#a150463ba2515263515f68599c580b64e">ZSEEK</a>(zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,
<a name="l01104"></a>01104                   zi-&gt;<a class="code" href="structzip__internal.html#ab087c0930e1deeaf9f3dc9199d88c18f">ci</a>.<a class="code" href="structcurfile__info.html#ae859aac5711395f5136a26a393f4f3ec">pos_local_header</a> + 14,<a class="code" href="ioapi_8h.html#a962e25bd3652f31479b855be08836c16">ZLIB_FILEFUNC_SEEK_SET</a>)!=0)
<a name="l01105"></a>01105             err = ZIP_ERRNO;
<a name="l01106"></a>01106 
<a name="l01107"></a>01107         <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l01108"></a>01108             err = <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,crc32,4); <span class="comment">/* crc 32, unknown */</span>
<a name="l01109"></a>01109 
<a name="l01110"></a>01110         <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>) <span class="comment">/* compressed size, unknown */</span>
<a name="l01111"></a>01111             err = <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,compressed_size,4);
<a name="l01112"></a>01112 
<a name="l01113"></a>01113         <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>) <span class="comment">/* uncompressed size, unknown */</span>
<a name="l01114"></a>01114             err = <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,uncompressed_size,4);
<a name="l01115"></a>01115 
<a name="l01116"></a>01116         <span class="keywordflow">if</span> (<a class="code" href="ioapi_8h.html#a150463ba2515263515f68599c580b64e">ZSEEK</a>(zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,
<a name="l01117"></a>01117                   cur_pos_inzip,<a class="code" href="ioapi_8h.html#a962e25bd3652f31479b855be08836c16">ZLIB_FILEFUNC_SEEK_SET</a>)!=0)
<a name="l01118"></a>01118             err = ZIP_ERRNO;
<a name="l01119"></a>01119     }
<a name="l01120"></a>01120 
<a name="l01121"></a>01121     zi-&gt;<a class="code" href="structzip__internal.html#a8415937c4a5b2afc0adde407d59f2750">number_entry</a> ++;
<a name="l01122"></a>01122     zi-&gt;<a class="code" href="structzip__internal.html#a98dbf3927482a45adefcd32d12bd7840">in_opened_file_inzip</a> = 0;
<a name="l01123"></a>01123 
<a name="l01124"></a>01124     <span class="keywordflow">return</span> err;
<a name="l01125"></a>01125 }
<a name="l01126"></a>01126 
<a name="l01127"></a><a class="code" href="zip_8c.html#ae470f753aef4cffe4f77a5ec2bcfbde1">01127</a> <span class="keyword">extern</span> <span class="keywordtype">int</span> ZEXPORT <a class="code" href="zip_8c.html#ae470f753aef4cffe4f77a5ec2bcfbde1">zipCloseFileInZip</a> (file)
<a name="l01128"></a>01128     <a class="code" href="zip_8h.html#af69b9a5ea9aaf8e8f0b7681e451b224c">zipFile</a> file;
<a name="l01129"></a>01129 {
<a name="l01130"></a>01130     <span class="keywordflow">return</span> <a class="code" href="zip_8c.html#a43fe6f36cef62c7f34c0fdb4c8288b87">zipCloseFileInZipRaw</a> (file,0,0);
<a name="l01131"></a>01131 }
<a name="l01132"></a>01132 
<a name="l01133"></a><a class="code" href="zip_8c.html#a4fda7a41fa2f57d105ffc7d1cbcf53cc">01133</a> <span class="keyword">extern</span> <span class="keywordtype">int</span> ZEXPORT <a class="code" href="zip_8c.html#a4fda7a41fa2f57d105ffc7d1cbcf53cc">zipClose</a> (file, global_comment)
<a name="l01134"></a>01134     <a class="code" href="zip_8h.html#af69b9a5ea9aaf8e8f0b7681e451b224c">zipFile</a> file;
<a name="l01135"></a>01135     const <span class="keywordtype">char</span>* global_comment;
<a name="l01136"></a>01136 {
<a name="l01137"></a>01137     <a class="code" href="structzip__internal.html">zip_internal</a>* zi;
<a name="l01138"></a>01138     <span class="keywordtype">int</span> err = 0;
<a name="l01139"></a>01139     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> size_centraldir = 0;
<a name="l01140"></a>01140     <a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a> centraldir_pos_inzip;
<a name="l01141"></a>01141     uInt size_global_comment;
<a name="l01142"></a>01142     <span class="keywordflow">if</span> (file == NULL)
<a name="l01143"></a>01143         <span class="keywordflow">return</span> ZIP_PARAMERROR;
<a name="l01144"></a>01144     zi = (<a class="code" href="structzip__internal.html">zip_internal</a>*)file;
<a name="l01145"></a>01145 
<a name="l01146"></a>01146     <span class="keywordflow">if</span> (zi-&gt;<a class="code" href="structzip__internal.html#a98dbf3927482a45adefcd32d12bd7840">in_opened_file_inzip</a> == 1)
<a name="l01147"></a>01147     {
<a name="l01148"></a>01148         err = <a class="code" href="zip_8c.html#ae470f753aef4cffe4f77a5ec2bcfbde1">zipCloseFileInZip</a> (file);
<a name="l01149"></a>01149     }
<a name="l01150"></a>01150 
<a name="l01151"></a>01151 <span class="preprocessor">#ifndef NO_ADDFILEINEXISTINGZIP</span>
<a name="l01152"></a>01152 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (global_comment==NULL)
<a name="l01153"></a>01153         global_comment = zi-&gt;<a class="code" href="structzip__internal.html#a8a49f83da0affc89cfc541ab38e72471">globalcomment</a>;
<a name="l01154"></a>01154 <span class="preprocessor">#endif</span>
<a name="l01155"></a>01155 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (global_comment==NULL)
<a name="l01156"></a>01156         size_global_comment = 0;
<a name="l01157"></a>01157     <span class="keywordflow">else</span>
<a name="l01158"></a>01158         size_global_comment = (uInt)strlen(global_comment);
<a name="l01159"></a>01159 
<a name="l01160"></a>01160     centraldir_pos_inzip = <a class="code" href="ioapi_8h.html#a6010b5be81cd016bf0fe649cea4cf2c2">ZTELL</a>(zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>);
<a name="l01161"></a>01161     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l01162"></a>01162     {
<a name="l01163"></a>01163         <a class="code" href="structlinkedlist__datablock__internal__s.html">linkedlist_datablock_internal</a>* ldi = zi-&gt;<a class="code" href="structzip__internal.html#ae63acf37b5a3719b3eae7802115ed73c">central_dir</a>.<a class="code" href="structlinkedlist__data__s.html#aa0a9c876ad4a05aa5969d8888fb57cdb">first_block</a> ;
<a name="l01164"></a>01164         <span class="keywordflow">while</span> (ldi!=NULL)
<a name="l01165"></a>01165         {
<a name="l01166"></a>01166             <span class="keywordflow">if</span> ((err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>) &amp;&amp; (ldi-&gt;<a class="code" href="structlinkedlist__datablock__internal__s.html#a76ae854b6029e6617c7544d2eb311f77">filled_in_this_block</a>&gt;0))
<a name="l01167"></a>01167                 <span class="keywordflow">if</span> (<a class="code" href="ioapi_8h.html#a440d7e7546b628b36ae22ab621d43d8c">ZWRITE</a>(zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,
<a name="l01168"></a>01168                            ldi-&gt;<a class="code" href="structlinkedlist__datablock__internal__s.html#a04900ee41fa2247a73b7570ec162bb1d">data</a>,ldi-&gt;<a class="code" href="structlinkedlist__datablock__internal__s.html#a76ae854b6029e6617c7544d2eb311f77">filled_in_this_block</a>)
<a name="l01169"></a>01169                               !=ldi-&gt;<a class="code" href="structlinkedlist__datablock__internal__s.html#a76ae854b6029e6617c7544d2eb311f77">filled_in_this_block</a> )
<a name="l01170"></a>01170                     err = ZIP_ERRNO;
<a name="l01171"></a>01171 
<a name="l01172"></a>01172             size_centraldir += ldi-&gt;<a class="code" href="structlinkedlist__datablock__internal__s.html#a76ae854b6029e6617c7544d2eb311f77">filled_in_this_block</a>;
<a name="l01173"></a>01173             ldi = ldi-&gt;<a class="code" href="structlinkedlist__datablock__internal__s.html#a1f5abadbf41d82b8724a048a33c4c153">next_datablock</a>;
<a name="l01174"></a>01174         }
<a name="l01175"></a>01175     }
<a name="l01176"></a>01176     <a class="code" href="zip_8c.html#abef16e3f609c5691bab782908095af3b">free_datablock</a>(zi-&gt;<a class="code" href="structzip__internal.html#ae63acf37b5a3719b3eae7802115ed73c">central_dir</a>.<a class="code" href="structlinkedlist__data__s.html#aa0a9c876ad4a05aa5969d8888fb57cdb">first_block</a>);
<a name="l01177"></a>01177 
<a name="l01178"></a>01178     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>) <span class="comment">/* Magic End */</span>
<a name="l01179"></a>01179         err = <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)<a class="code" href="zip_8c.html#a919e00d5518c0ac9c5f46f7265d4c292">ENDHEADERMAGIC</a>,4);
<a name="l01180"></a>01180 
<a name="l01181"></a>01181     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>) <span class="comment">/* number of this disk */</span>
<a name="l01182"></a>01182         err = <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)0,2);
<a name="l01183"></a>01183 
<a name="l01184"></a>01184     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>) <span class="comment">/* number of the disk with the start of the central directory */</span>
<a name="l01185"></a>01185         err = <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)0,2);
<a name="l01186"></a>01186 
<a name="l01187"></a>01187     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>) <span class="comment">/* total number of entries in the central dir on this disk */</span>
<a name="l01188"></a>01188         err = <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)zi-&gt;<a class="code" href="structzip__internal.html#a8415937c4a5b2afc0adde407d59f2750">number_entry</a>,2);
<a name="l01189"></a>01189 
<a name="l01190"></a>01190     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>) <span class="comment">/* total number of entries in the central dir */</span>
<a name="l01191"></a>01191         err = <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)zi-&gt;<a class="code" href="structzip__internal.html#a8415937c4a5b2afc0adde407d59f2750">number_entry</a>,2);
<a name="l01192"></a>01192 
<a name="l01193"></a>01193     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>) <span class="comment">/* size of the central directory */</span>
<a name="l01194"></a>01194         err = <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)size_centraldir,4);
<a name="l01195"></a>01195 
<a name="l01196"></a>01196     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>) <span class="comment">/* offset of start of central directory with respect to the</span>
<a name="l01197"></a>01197 <span class="comment">                            starting disk number */</span>
<a name="l01198"></a>01198         err = <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,
<a name="l01199"></a>01199                                 (<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)(centraldir_pos_inzip - zi-&gt;<a class="code" href="structzip__internal.html#a6cd048a07f19de1144c9a7edc3645422">add_position_when_writting_offset</a>),4);
<a name="l01200"></a>01200 
<a name="l01201"></a>01201     <span class="keywordflow">if</span> (err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>) <span class="comment">/* zipfile comment length */</span>
<a name="l01202"></a>01202         err = <a class="code" href="zip_8c.html#a0217cc99e344c701c36e2eb05a9f2682">ziplocal_putValue</a>(&amp;zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,(<a class="code" href="ioapi_8h.html#a50e9e9d5c30e481de822ad68fe537986">uLong</a>)size_global_comment,2);
<a name="l01203"></a>01203 
<a name="l01204"></a>01204     <span class="keywordflow">if</span> ((err==<a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>) &amp;&amp; (size_global_comment&gt;0))
<a name="l01205"></a>01205         <span class="keywordflow">if</span> (<a class="code" href="ioapi_8h.html#a440d7e7546b628b36ae22ab621d43d8c">ZWRITE</a>(zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>,
<a name="l01206"></a>01206                    global_comment,size_global_comment) != size_global_comment)
<a name="l01207"></a>01207                 err = ZIP_ERRNO;
<a name="l01208"></a>01208 
<a name="l01209"></a>01209     <span class="keywordflow">if</span> (<a class="code" href="ioapi_8h.html#a715986c0415785fdc35877402429a366">ZCLOSE</a>(zi-&gt;<a class="code" href="structzip__internal.html#a52b481ed001fdb87cc389c128b8c0f6e">z_filefunc</a>,zi-&gt;<a class="code" href="structzip__internal.html#a1444d3938300b2fa4e8f1e2a99475138">filestream</a>) != 0)
<a name="l01210"></a>01210         <span class="keywordflow">if</span> (err == <a class="code" href="zip_8h.html#a394355d595e63f49e769ecd250222336">ZIP_OK</a>)
<a name="l01211"></a>01211             err = ZIP_ERRNO;
<a name="l01212"></a>01212 
<a name="l01213"></a>01213 <span class="preprocessor">#ifndef NO_ADDFILEINEXISTINGZIP</span>
<a name="l01214"></a>01214 <span class="preprocessor"></span>    <a class="code" href="zip_8c.html#a5fb23c00a00f3856832e660edc2ab03d">TRYFREE</a>(zi-&gt;<a class="code" href="structzip__internal.html#a8a49f83da0affc89cfc541ab38e72471">globalcomment</a>);
<a name="l01215"></a>01215 <span class="preprocessor">#endif</span>
<a name="l01216"></a>01216 <span class="preprocessor"></span>    <a class="code" href="zip_8c.html#a5fb23c00a00f3856832e660edc2ab03d">TRYFREE</a>(zi);
<a name="l01217"></a>01217 
<a name="l01218"></a>01218     <span class="keywordflow">return</span> err;
<a name="l01219"></a>01219 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Fri Jun 25 2010 09:45:38 for Grabla by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.0 </small></address>
</body>
</html>
